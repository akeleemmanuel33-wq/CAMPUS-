<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile ‚Äî Campus</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/profile.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- PAGE -->
  <main class="page">
    <div class="container">

      <!-- LOADING -->
      <div id="loading-wrap" class="loading-wrap">
        <div class="spinner"></div>
      </div>

      <!-- CONTENT -->
      <div id="profile-content" style="display:none;">

        <!-- ‚îÄ‚îÄ TOP SECTION ‚îÄ‚îÄ -->
        <div class="profile-top">

          <!-- Avatar + Info -->
          <div class="profile-hero card">
            <div class="profile-avatar-wrap">
              <div class="profile-avatar" id="profile-avatar"></div>
              <div class="profile-avatar-ring"></div>
            </div>
            <div class="profile-info">
              <h1 class="profile-name" id="profile-name"></h1>
              <p class="profile-uni" id="profile-uni"></p>
              <p class="profile-email" id="profile-email"></p>
              <p class="profile-joined" id="profile-joined"></p>
            </div>
            <button class="btn btn-ghost btn-sm" id="edit-btn" style="align-self:flex-start;">
              ‚úèÔ∏è Edit Profile
            </button>
          </div>

          <!-- Stats row -->
          <div class="stats-row">
            <div class="stat-box card">
              <span class="stat-icon">üì§</span>
              <span class="stat-num" id="stat-uploads">‚Äî</span>
              <span class="stat-label">Uploads</span>
            </div>
            <div class="stat-box card">
              <span class="stat-icon">üëÄ</span>
              <span class="stat-num" id="stat-views">‚Äî</span>
              <span class="stat-label">PDFs Viewed</span>
            </div>
            <div class="stat-box card">
              <span class="stat-icon">‚¨áÔ∏è</span>
              <span class="stat-num" id="stat-downloads">‚Äî</span>
              <span class="stat-label">Downloads</span>
            </div>
          </div>

        </div>

        <!-- ‚îÄ‚îÄ TWO COLUMN LAYOUT ‚îÄ‚îÄ -->
        <div class="profile-grid">

          <!-- LEFT COLUMN -->
          <div class="profile-left">

            <!-- Monthly upload limit -->
            <div class="card limit-card">
              <div class="limit-header">
                <h3 class="limit-title">Monthly Uploads</h3>
                <span class="limit-badge" id="limit-badge"></span>
              </div>
              <div class="limit-nums">
                <span id="limit-used">0</span>
                <span class="limit-slash">/</span>
                <span>10</span>
              </div>
              <div class="progress-wrap" style="margin:12px 0;">
                <div class="progress-fill" id="limit-bar" style="width:0%"></div>
              </div>
              <p class="limit-reset" id="limit-reset"></p>
              <a href="upload.html" class="btn btn-primary btn-full" style="margin-top:16px;">
                + Upload New PDF
              </a>
            </div>

            <!-- Access status -->
            <div class="card access-card">
              <h3 class="section-title" style="font-size:16px;margin-bottom:16px;">Access Status</h3>
              <div class="access-item" id="access-views">
                <div class="access-icon">üëÄ</div>
                <div class="access-info">
                  <p class="access-label">View 10 PDFs</p>
                  <p class="access-desc">Unlocks downloads & uploads</p>
                </div>
                <div class="access-status" id="access-views-status"></div>
              </div>
              <div class="access-item" id="access-uploads">
                <div class="access-icon">üì§</div>
                <div class="access-info">
                  <p class="access-label">Upload PDFs</p>
                  <p class="access-desc">Share materials with students</p>
                </div>
                <div class="access-status" id="access-uploads-status"></div>
              </div>
              <div class="access-item">
                <div class="access-icon">‚¨áÔ∏è</div>
                <div class="access-info">
                  <p class="access-label">Download PDFs</p>
                  <p class="access-desc">Save materials to your device</p>
                </div>
                <div class="access-status" id="access-downloads-status"></div>
              </div>
            </div>

          </div>

          <!-- RIGHT COLUMN -->
          <div class="profile-right">

            <!-- My Uploads -->
            <div>
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                <h2 class="section-title" style="margin:0;">My Uploads</h2>
                <a href="upload.html" class="btn btn-outline btn-sm">+ New</a>
              </div>

              <!-- Loading -->
              <div id="uploads-loading" class="loading-wrap" style="padding:40px 0;">
                <div class="spinner"></div>
              </div>

              <!-- Empty -->
              <div id="uploads-empty" class="empty-state" style="display:none;">
                <div class="empty-icon">üì≠</div>
                <h3>No uploads yet</h3>
                <p>Share your first PDF with Nigerian students</p>
                <a href="upload.html" class="btn btn-primary" style="margin-top:16px;">Upload PDF</a>
              </div>

              <!-- Grid -->
              <div class="pdf-grid" id="uploads-grid" style="display:none;"></div>

            </div>

          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- EDIT PROFILE MODAL -->
  <div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card card">
      <div class="modal-header">
        <h3 class="modal-title">Edit Profile</h3>
        <button class="modal-close" id="modal-close">‚úï</button>
      </div>

      <form id="edit-form" style="display:flex;flex-direction:column;gap:18px;">

        <div class="input-group">
          <label class="input-label" for="edit-name">Full Name</label>
          <input class="input" type="text" id="edit-name" placeholder="Your full name" />
          <span class="field-error" id="edit-name-error"></span>
        </div>

        <div class="input-group">
          <label class="input-label">University</label>
          <div class="uni-dropdown-wrap">
            <input class="input" type="text" id="edit-uni-search" placeholder="Search university..." autocomplete="off" />
            <div class="uni-dropdown" id="edit-uni-dropdown"></div>
            <input type="hidden" id="edit-uni-id" />
          </div>
        </div>

        <div class="alert alert-error" id="edit-error" style="display:none;"></div>
        <div class="alert alert-success" id="edit-success" style="display:none;"></div>

        <div style="display:flex;gap:10px;">
          <button type="button" class="btn btn-ghost btn-full" id="cancel-edit">Cancel</button>
          <button type="submit" class="btn btn-primary btn-full" id="save-btn">
            <span id="save-text">Save Changes</span>
            <span id="save-spinner" class="btn-spinner" style="display:none;"></span>
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { supabase }                    from './js/supabase.js'
    import { buildNav, buildFooter, toast,
             formatDate, formatSize,
             uniBadgeClass,
             buildUniDropdown }            from './js/ui.js'
    import { requireAuth }                 from './js/auth.js'

    let session = null
    let profile = null

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
      session = await requireAuth()
      if (!session) return

      await buildNav('profile')
      buildFooter()
      await loadProfile()
    }

    // ‚îÄ‚îÄ Load Profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*, universities(name, short_name, type)')
        .eq('id', session.user.id)
        .single()

      if (error || !data) {
        toast('Failed to load profile', 'error')
        return
      }

      profile = data

      // Get view count
      const { count: viewCount } = await supabase
        .from('download_logs')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', session.user.id)
        .eq('action', 'view')

      // Get download count
      const { count: dlCount } = await supabase
        .from('download_logs')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', session.user.id)
        .eq('action', 'download')

      // Get total upload count (all time)
      const { count: totalUploads } = await supabase
        .from('pdfs')
        .select('*', { count: 'exact', head: true })
        .eq('uploader_id', session.user.id)

      renderProfile(profile, viewCount || 0, dlCount || 0, totalUploads || 0)
      await loadMyUploads()
      bindEditModal()

      document.getElementById('loading-wrap').style.display   = 'none'
      document.getElementById('profile-content').style.display = 'block'
    }

    // ‚îÄ‚îÄ Render Profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderProfile(p, views, downloads, totalUploads) {
      const uniName = p.universities
        ? `${p.universities.name} (${p.universities.short_name})`
        : 'University not set'

      const initials = p.full_name
        .split(' ').slice(0, 2)
        .map(n => n[0].toUpperCase()).join('')

      // Avatar
      const avatar = document.getElementById('profile-avatar')
      avatar.textContent = initials

      // Info
      document.getElementById('profile-name').textContent    = p.full_name
      document.getElementById('profile-uni').textContent     = uniName
      document.getElementById('profile-email').textContent   = session.user.email
      document.getElementById('profile-joined').textContent  = `Joined ${formatDate(p.created_at)}`

      // Stats
      document.getElementById('stat-uploads').textContent   = totalUploads
      document.getElementById('stat-views').textContent     = views
      document.getElementById('stat-downloads').textContent = downloads

      // Monthly limit
      const used = p.upload_count_this_month || 0
      document.getElementById('limit-used').textContent = used
      document.getElementById('limit-bar').style.width  = `${(used / 10) * 100}%`

      if (used >= 10) {
        document.getElementById('limit-bar').classList.add('danger')
        document.getElementById('limit-badge').textContent  = 'FULL'
        document.getElementById('limit-badge').className    = 'limit-badge limit-badge-full'
      } else if (used >= 7) {
        document.getElementById('limit-bar').classList.add('warning')
        document.getElementById('limit-badge').textContent  = `${10 - used} left`
        document.getElementById('limit-badge').className    = 'limit-badge limit-badge-warn'
      } else {
        document.getElementById('limit-badge').textContent  = `${10 - used} left`
        document.getElementById('limit-badge').className    = 'limit-badge limit-badge-ok'
      }

      // Reset date
      const resetDate = new Date()
      resetDate.setMonth(resetDate.getMonth() + 1, 1)
      document.getElementById('limit-reset').textContent =
        `Resets ${resetDate.toLocaleDateString('en-NG', { day: 'numeric', month: 'long' })}`

      // Access status
      const canView     = views >= 10
      const canUpload   = canView && used < 10
      const canDownload = canView

      renderAccessItem('access-views-status',     canView,     views,    10, 'views')
      renderAccessItem('access-uploads-status',   canUpload,   used,     10, 'uploads')
      renderAccessItem('access-downloads-status', canDownload, views,    10, 'views')
    }

    function renderAccessItem(elId, unlocked, current, max, unit) {
      const el = document.getElementById(elId)
      if (!el) return
      if (unlocked) {
        el.innerHTML = `<span class="access-check">‚úÖ</span>`
      } else {
        el.innerHTML = `<span class="access-progress">${current}/${max} ${unit}</span>`
      }
    }

    // ‚îÄ‚îÄ Load My Uploads ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadMyUploads() {
      const loadingEl = document.getElementById('uploads-loading')
      const emptyEl   = document.getElementById('uploads-empty')
      const gridEl    = document.getElementById('uploads-grid')

      const { data, error } = await supabase
        .from('pdfs')
        .select(`
          id, title, type, file_size_mb,
          download_count, created_at, is_approved,
          universities(name, short_name, type)
        `)
        .eq('uploader_id', session.user.id)
        .order('created_at', { ascending: false })

      loadingEl.style.display = 'none'

      if (error || !data || data.length === 0) {
        emptyEl.style.display = 'block'
        return
      }

      gridEl.style.display = 'grid'

      data.forEach(pdf => {
        const uniType = pdf.universities?.type || 'Federal'
        const uniName = pdf.universities
          ? `${pdf.universities.name} (${pdf.universities.short_name})`
          : '‚Äî'

        const card = document.createElement('div')
        card.className = 'card card-hover pdf-card'
        card.innerHTML = `
          <div class="pdf-card-meta">
            <span class="badge ${pdf.type === 'Material' ? 'badge-material' : 'badge-past'}">
              ${pdf.type === 'Material' ? 'üìö' : 'üìù'} ${pdf.type}
            </span>
            <span class="badge ${uniBadgeClass(uniType)}">${uniType}</span>
            ${!pdf.is_approved ? '<span class="badge" style="background:rgba(239,68,68,0.15);color:var(--red);border-color:rgba(239,68,68,0.3);">Pending</span>' : ''}
          </div>
          <h3 class="pdf-card-title">${pdf.title}</h3>
          <p class="pdf-card-uni">üè´ ${uniName}</p>
          <p class="pdf-card-info">üìÖ ${formatDate(pdf.created_at)}</p>
          <div class="pdf-card-footer">
            <span class="pdf-card-stats">‚¨áÔ∏è ${pdf.download_count || 0} ¬∑ üìÅ ${formatSize(pdf.file_size_mb)}</span>
            <button class="btn btn-sm view-btn"
              style="background:var(--green-dim);color:var(--green);border:1px solid var(--green-border);"
              onclick="window.location.href='view.html?id=${pdf.id}'">
              View
            </button>
            <button class="btn btn-sm delete-btn"
              style="background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);"
              data-id="${pdf.id}" data-title="${pdf.title}">
              üóëÔ∏è
            </button>
          </div>
        `

        // Delete button
        card.querySelector('.delete-btn').addEventListener('click', (e) => {
          e.stopPropagation()
          handleDelete(pdf.id, pdf.title, pdf.file_url, card)
        })

        gridEl.appendChild(card)
      })
    }

    // ‚îÄ‚îÄ Delete Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function handleDelete(pdfId, title, fileUrl, cardEl) {
      const confirmed = confirm(`Delete "${title}"?\n\nThis cannot be undone.`)
      if (!confirmed) return

      // Remove from DB
      const { error: dbErr } = await supabase
        .from('pdfs')
        .delete()
        .eq('id', pdfId)
        .eq('uploader_id', session.user.id)

      if (dbErr) {
        toast('Failed to delete. Try again.', 'error')
        return
      }

      // Remove from storage
      await supabase.storage.from('pdfs').remove([fileUrl])

      // Remove card from UI
      cardEl.style.opacity    = '0'
      cardEl.style.transform  = 'scale(0.95)'
      cardEl.style.transition = 'all 0.3s'
      setTimeout(() => cardEl.remove(), 300)

      toast(`"${title}" deleted`, 'success')

      // Show empty if no more cards
      const remaining = document.querySelectorAll('#uploads-grid .card').length
      if (remaining === 0) {
        document.getElementById('uploads-grid').style.display = 'none'
        document.getElementById('uploads-empty').style.display = 'block'
      }
    }

    // ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function bindEditModal() {
      const modal     = document.getElementById('edit-modal')
      const editBtn   = document.getElementById('edit-btn')
      const closeBtn  = document.getElementById('modal-close')
      const cancelBtn = document.getElementById('cancel-edit')

      // Open modal
      editBtn.addEventListener('click', async () => {
        modal.style.display = 'flex'
        document.body.style.overflow = 'hidden'

        // Pre-fill
        document.getElementById('edit-name').value = profile.full_name
        if (profile.universities) {
          document.getElementById('edit-uni-search').value =
            `${profile.universities.name} (${profile.universities.short_name})`
          document.getElementById('edit-uni-id').value = profile.university_id
        }

        await buildUniDropdown('edit-uni-search', 'edit-uni-dropdown', 'edit-uni-id')
      })

      // Close modal
      const closeModal = () => {
        modal.style.display = 'none'
        document.body.style.overflow = ''
        document.getElementById('edit-error').style.display   = 'none'
        document.getElementById('edit-success').style.display = 'none'
      }

      closeBtn.addEventListener('click', closeModal)
      cancelBtn.addEventListener('click', closeModal)
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal() })

      // Save
      document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault()

        const name  = document.getElementById('edit-name').value.trim()
        const uniId = document.getElementById('edit-uni-id').value

        document.getElementById('edit-name-error').textContent = ''
        document.getElementById('edit-error').style.display    = 'none'
        document.getElementById('edit-success').style.display  = 'none'

        if (!name || name.split(' ').length < 2) {
          document.getElementById('edit-name-error').textContent = 'Enter your full name'
          return
        }

        // Loading
        const saveBtn     = document.getElementById('save-btn')
        const saveText    = document.getElementById('save-text')
        const saveSpinner = document.getElementById('save-spinner')
        saveBtn.disabled        = true
        saveText.style.display  = 'none'
        saveSpinner.style.display = 'inline-block'

        const updates = { full_name: name }
        if (uniId) updates.university_id = uniId

        const { error } = await supabase
          .from('profiles')
          .update(updates)
          .eq('id', session.user.id)

        saveBtn.disabled        = false
        saveText.style.display  = 'inline'
        saveSpinner.style.display = 'none'

        if (error) {
          document.getElementById('edit-error').style.display = 'block'
          document.getElementById('edit-error').textContent   = error.message
          return
        }

        // Update UI
        document.getElementById('profile-name').textContent = name
        const initials = name.split(' ').slice(0, 2).map(n => n[0].toUpperCase()).join('')
        document.getElementById('profile-avatar').textContent = initials
        document.getElementById('nav-username').textContent   = name.split(' ')[0]

        document.getElementById('edit-success').style.display = 'block'
        document.getElementById('edit-success').textContent   = '‚úÖ Profile updated!'
        toast('Profile updated! üéâ', 'success')

        // Reload profile data
        await loadProfile()
        setTimeout(closeModal, 1200)
      })
    }

    init()
  </script>

</body>
</html>
