<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile ‚Äî Campus</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/profile.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- PAGE -->
  <main class="page">
    <div class="container">

      <!-- LOADING -->
      <div id="loading-wrap" class="loading-wrap">
        <div class="spinner"></div>
      </div>

      <!-- CONTENT -->
      <div id="profile-content" style="display:none;">

        <!-- ‚îÄ‚îÄ TOP SECTION ‚îÄ‚îÄ -->
        <div class="profile-top">

          <!-- Avatar + Info -->
          <div class="profile-hero card">
            <div class="profile-avatar-wrap">
              <div class="profile-avatar" id="profile-avatar"></div>
              <div class="profile-avatar-ring"></div>
            </div>
            <div class="profile-info">
              <h1 class="profile-name" id="profile-name"></h1>
              <p class="profile-uni" id="profile-uni"></p>
              <p class="profile-email" id="profile-email"></p>
              <p class="profile-joined" id="profile-joined"></p>
            </div>
            <button class="btn btn-ghost btn-sm" id="edit-btn" style="align-self:flex-start;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3.78181 16.3092L3 21L7.69086 20.2182C8.50544 20.0825 9.25725 19.6956 9.84119 19.1116L20.4198 8.53288C21.1934 7.75922 21.1934 6.5049 20.4197 5.73126L18.2687 3.58024C17.495 2.80658 16.2406 2.80659 15.4669 3.58027L4.88841 14.159C4.30447 14.7429 3.91757 15.4947 3.78181 16.3092Z" />
    <path d="M14 6L18 10" />
</svg> Edit Profile
            </button>
          </div>

          <!-- Stats row -->
          <div class="stats-row">
            <div class="stat-box card">
              <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
    <path d="M21 21H10C6.70017 21 5.05025 21 4.02513 19.9749C3 18.9497 3 17.2998 3 14V3" />
    <path d="M7 4H8" />
    <path d="M7 7H11" />
    <path d="M5 20C6.07093 18.053 7.52279 13.0189 10.3063 13.0189C12.2301 13.0189 12.7283 15.4717 14.6136 15.4717C17.8572 15.4717 17.387 10 21 10" />
</svg></span>
              <span class="stat-num" id="stat-uploads">‚Äî</span>
              <span class="stat-label">Uploads</span>
            </div>
            <div class="stat-box card">
              <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5"> <path d="M21.544 11.045C21.848 11.4713 22 11.6845 22 12C22 12.3155 21.848 12.5287 21.544 12.955C20.1779 14.8706 16.6892 19 12 19C7.31078 19 3.8221 14.8706 2.45604 12.955C2.15201 12.5287 2 12.3155 2 12C2 11.6845 2.15201 11.4713 2.45604 11.045C3.8221 9.12944 7.31078 5 12 5C16.6892 5 20.1779 9.12944 21.544 11.045Z" /> <path d="M15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12Z" /> </svg></span>
              <span class="stat-num" id="stat-views">‚Äî</span>
              <span class="stat-label">PDFs Viewed</span>
            </div>
            <div class="stat-box card">
              <span class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" /> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" /> </svg></span>
              <span class="stat-num" id="stat-downloads">‚Äî</span>
              <span class="stat-label">Downloads</span>
            </div>
          </div>

        </div>

        <!-- ‚îÄ‚îÄ TWO COLUMN LAYOUT ‚îÄ‚îÄ -->
        <div class="profile-grid">

          <!-- LEFT COLUMN -->
          <div class="profile-left">

            <!-- Monthly upload limit -->
            <div class="card limit-card">
              <div class="limit-header">
                <h3 class="limit-title">Monthly Uploads</h3>
                <span class="limit-badge" id="limit-badge"></span>
              </div>
              <div class="limit-nums">
                <span id="limit-used">0</span>
                <span class="limit-slash">/</span>
                <span>10</span>
              </div>
              <div class="progress-wrap" style="margin:12px 0;">
                <div class="progress-fill" id="limit-bar" style="width:0%"></div>
              </div>
              <p class="limit-reset" id="limit-reset"></p>
              <a href="upload.html" class="btn btn-primary btn-full" style="margin-top:16px;">
                + Upload New PDF
              </a>
            </div>

            <!-- Access status -->
            <div class="card access-card">
              <h3 class="section-title" style="font-size:16px;margin-bottom:16px;">Access Status</h3>
              <div class="access-item" id="access-views">
                <div class="access-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5"> <path d="M21.544 11.045C21.848 11.4713 22 11.6845 22 12C22 12.3155 21.848 12.5287 21.544 12.955C20.1779 14.8706 16.6892 19 12 19C7.31078 19 3.8221 14.8706 2.45604 12.955C2.15201 12.5287 2 12.3155 2 12C2 11.6845 2.15201 11.4713 2.45604 11.045C3.8221 9.12944 7.31078 5 12 5C16.6892 5 20.1779 9.12944 21.544 11.045Z" /> <path d="M15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12Z" /> </svg></div>
                <div class="access-info">
                  <p class="access-label">View 10 PDFs</p>
                  <p class="access-desc">Unlocks downloads & uploads</p>
                </div>
                <div class="access-status" id="access-views-status"></div>
              </div>
              <div class="access-item" id="access-uploads">
                <div class="access-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M16.9503 8.3183C17.198 7.68602 16.5075 6.92738 15.1266 5.41011C13.6701 3.80984 12.92 3.00959 11.9999 3C11.0798 3.00959 10.3297 3.80984 8.8732 5.41011C7.49228 6.92738 6.80182 7.68602 7.04953 8.3183C7.05858 8.34138 7.0684 8.36414 7.07899 8.38653C7.34917 8.95795 8.24467 8.99712 9.99989 8.9998V15.5C9.99989 15.965 9.99989 16.1975 10.051 16.3882C10.1897 16.9059 10.594 17.3102 11.1117 17.4489C11.3024 17.5 11.5349 17.5 11.9999 17.5C12.4648 17.5 12.6973 17.5 12.8881 17.4489C13.4057 17.3102 13.81 16.9059 13.9487 16.3882C13.9999 16.1975 13.9999 15.965 13.9999 15.5V8.9998C15.7551 8.99712 16.6506 8.95796 16.9208 8.38653C16.9314 8.36414 16.9412 8.34138 16.9503 8.3183Z" />
    <path d="M4.99998 21H19" />
</svg></div>
                <div class="access-info">
                  <p class="access-label">Upload PDFs</p>
                  <p class="access-desc">Share materials with students</p>
                </div>
                <div class="access-status" id="access-uploads-status"></div>
              </div>
              <div class="access-item">
                <div class="access-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" /> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" /> </svg></div>
                <div class="access-info">
                  <p class="access-label">Download PDFs</p>
                  <p class="access-desc">Save materials to your device</p>
                </div>
                <div class="access-status" id="access-downloads-status"></div>
              </div>
            </div>

          </div>

          <!-- RIGHT COLUMN -->
          <div class="profile-right">

            <!-- My Uploads -->
            <div>
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
                <h2 class="section-title" style="margin:0;">My Uploads</h2>
                <a href="upload.html" class="btn btn-outline btn-sm">+ New</a>
              </div>

              <!-- Loading -->
              <div id="uploads-loading" class="loading-wrap" style="padding:40px 0;">
                <div class="spinner"></div>
              </div>

              <!-- Empty -->
              <div id="uploads-empty" class="empty-state" style="display:none;">
                <div class="empty-icon">üì≠</div>
                <h3>No uploads yet</h3>
                <p>Share your first PDF with Nigerian students</p>
                <a href="upload.html" class="btn btn-primary" style="margin-top:16px;">Upload PDF</a>
              </div>

              <!-- Grid -->
              <div class="pdf-grid" id="uploads-grid" style="display:none;"></div>

            </div>

          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- EDIT PROFILE MODAL -->
  <div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card card">
      <div class="modal-header">
        <h3 class="modal-title">Edit Profile</h3>
        <button class="modal-close" id="modal-close">‚úï</button>
      </div>

      <form id="edit-form" style="display:flex;flex-direction:column;gap:18px;">

        <div class="input-group">
          <label class="input-label" for="edit-name">Full Name</label>
          <input class="input" type="text" id="edit-name" placeholder="Your full name" />
          <span class="field-error" id="edit-name-error"></span>
        </div>

        <div class="input-group">
          <label class="input-label">University</label>
          <div class="uni-dropdown-wrap">
            <input class="input" type="text" id="edit-uni-search" placeholder="Search university..." autocomplete="off" />
            <div class="uni-dropdown" id="edit-uni-dropdown"></div>
            <input type="hidden" id="edit-uni-id" />
          </div>
        </div>

        <div class="alert alert-error" id="edit-error" style="display:none;"></div>
        <div class="alert alert-success" id="edit-success" style="display:none;"></div>

        <div style="display:flex;gap:10px;">
          <button type="button" class="btn btn-ghost btn-full" id="cancel-edit">Cancel</button>
          <button type="submit" class="btn btn-primary btn-full" id="save-btn">
            <span id="save-text">Save Changes</span>
            <span id="save-spinner" class="btn-spinner" style="display:none;"></span>
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { supabase }                    from './js/supabase.js'
    import { buildNav, buildFooter, toast,
             formatDate, formatSize,
             uniBadgeClass,
             buildUniDropdown }            from './js/ui.js'
    import { requireAuth }                 from './js/auth.js'

    let session = null
    let profile = null

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
      session = await requireAuth()
      if (!session) return

      await buildNav('profile')
      buildFooter()
      await loadProfile()
    }

    // ‚îÄ‚îÄ Load Profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*, universities(name, short_name, type)')
        .eq('id', session.user.id)
        .single()

      if (error || !data) {
        toast('Failed to load profile', 'error')
        return
      }

      profile = data

      // Get view count
      const { count: viewCount } = await supabase
        .from('download_logs')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', session.user.id)
        .eq('action', 'view')

      // Get download count
      const { count: dlCount } = await supabase
        .from('download_logs')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', session.user.id)
        .eq('action', 'download')

      // Get total upload count (all time)
      const { count: totalUploads } = await supabase
        .from('pdfs')
        .select('*', { count: 'exact', head: true })
        .eq('uploader_id', session.user.id)

      renderProfile(profile, viewCount || 0, dlCount || 0, totalUploads || 0)
      await loadMyUploads()
      bindEditModal()

      document.getElementById('loading-wrap').style.display   = 'none'
      document.getElementById('profile-content').style.display = 'block'
    }

    // ‚îÄ‚îÄ Render Profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderProfile(p, views, downloads, totalUploads) {
      const uniName = p.universities
        ? `${p.universities.name} (${p.universities.short_name})`
        : 'University not set'

      const initials = p.full_name
        .split(' ').slice(0, 2)
        .map(n => n[0].toUpperCase()).join('')

      // Avatar
      const avatar = document.getElementById('profile-avatar')
      avatar.textContent = initials

      // Info
      document.getElementById('profile-name').textContent    = p.full_name
      document.getElementById('profile-uni').textContent     = uniName
      document.getElementById('profile-email').textContent   = session.user.email
      document.getElementById('profile-joined').textContent  = `Joined ${formatDate(p.created_at)}`

      // Stats
      document.getElementById('stat-uploads').textContent   = totalUploads
      document.getElementById('stat-views').textContent     = views
      document.getElementById('stat-downloads').textContent = downloads

      // Monthly limit
      const used = p.upload_count_this_month || 0
      document.getElementById('limit-used').textContent = used
      document.getElementById('limit-bar').style.width  = `${(used / 10) * 100}%`

      if (used >= 10) {
        document.getElementById('limit-bar').classList.add('danger')
        document.getElementById('limit-badge').textContent  = 'FULL'
        document.getElementById('limit-badge').className    = 'limit-badge limit-badge-full'
      } else if (used >= 7) {
        document.getElementById('limit-bar').classList.add('warning')
        document.getElementById('limit-badge').textContent  = `${10 - used} left`
        document.getElementById('limit-badge').className    = 'limit-badge limit-badge-warn'
      } else {
        document.getElementById('limit-badge').textContent  = `${10 - used} left`
        document.getElementById('limit-badge').className    = 'limit-badge limit-badge-ok'
      }

      // Reset date
      const resetDate = new Date()
      resetDate.setMonth(resetDate.getMonth() + 1, 1)
      document.getElementById('limit-reset').textContent =
        `Resets ${resetDate.toLocaleDateString('en-NG', { day: 'numeric', month: 'long' })}`

      // Access status
      const canView     = views >= 10
      const canUpload   = canView && used < 10
      const canDownload = canView

      renderAccessItem('access-views-status',     canView,     views,    10, 'views')
      renderAccessItem('access-uploads-status',   canUpload,   used,     10, 'uploads')
      renderAccessItem('access-downloads-status', canDownload, views,    10, 'views')
    }

    function renderAccessItem(elId, unlocked, current, max, unit) {
      const el = document.getElementById(elId)
      if (!el) return
      if (unlocked) {
        el.innerHTML = `<span class="access-check">‚úÖ</span>`
      } else {
        el.innerHTML = `<span class="access-progress">${current}/${max} ${unit}</span>`
      }
    }

    // ‚îÄ‚îÄ Load My Uploads ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadMyUploads() {
      const loadingEl = document.getElementById('uploads-loading')
      const emptyEl   = document.getElementById('uploads-empty')
      const gridEl    = document.getElementById('uploads-grid')

      const { data, error } = await supabase
        .from('pdfs')
        .select(`
          id, title, type, file_size_mb,
          download_count, created_at, is_approved,
          universities(name, short_name, type)
        `)
        .eq('uploader_id', session.user.id)
        .order('created_at', { ascending: false })

      loadingEl.style.display = 'none'

      if (error || !data || data.length === 0) {
        emptyEl.style.display = 'block'
        return
      }

      gridEl.style.display = 'grid'

      data.forEach(pdf => {
        const uniType = pdf.universities?.type || 'Federal'
        const uniName = pdf.universities
          ? `${pdf.universities.name} (${pdf.universities.short_name})`
          : '‚Äî'

        const card = document.createElement('div')
        card.className = 'card card-hover pdf-card'
        card.innerHTML = `
          <div class="pdf-card-meta">
            <span class="badge ${pdf.type === 'Material' ? 'badge-material' : 'badge-past'}">
              ${pdf.type === 'Material' ? 'üìö' : 'üìù'} ${pdf.type}
            </span>
            <span class="badge ${uniBadgeClass(uniType)}">${uniType}</span>
            ${!pdf.is_approved ? '<span class="badge" style="background:rgba(239,68,68,0.15);color:var(--red);border-color:rgba(239,68,68,0.3);">Pending</span>' : ''}
          </div>
          <h3 class="pdf-card-title">${pdf.title}</h3>
          <p class="pdf-card-uni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 20" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 22H21.5" /> <path d="M3 13V22M21 13V22" /> <path d="M7.5 8V22M16.5 8V22" /> <path d="M2 13H7M22 13H17" /> <path d="M6.5 8H17.5" /> <path d="M12 8V4.98221M12 4.98221V2.97035C12 2.49615 12 2.25905 12.1464 2.11173C12.6061 1.64939 14.5 2.74303 15.2203 3.18653C15.8285 3.56105 16 4.30914 16 4.98221H12Z" /> <path d="M12 22L12 20" /> <path d="M10.5 12L10.5 12.5M13.5 12V12.5" /> <path d="M10.5 16L10.5 16.5M13.5 16V16.5" /> </svg> ${uniName}</p>
          <p class="pdf-card-info"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M16 2V6M8 2V6" /> <path d="M13 4H11C7.22876 4 5.34315 4 4.17157 5.17157C3 6.34315 3 8.22876 3 12V14C3 17.7712 3 19.6569 4.17157 20.8284C5.34315 22 7.22876 22 11 22H13C16.7712 22 18.6569 22 19.8284 20.8284C21 19.6569 21 17.7712 21 14V12C21 8.22876 21 6.34315 19.8284 5.17157C18.6569 4 16.7712 4 13 4Z" /> <path d="M3 10H21" /> <path d="M11 14H16M8 14H8.00898M13 18H8M16 18H15.991" /> </svg>  ${formatDate(pdf.created_at)}</p>
          <div class="pdf-card-footer">
            <span class="pdf-card-stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" /> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" /> </svg> ${pdf.download_count || 0} ¬∑ <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 19V7.54902C2 6.10516 2 5.38322 2.24332 4.81647C2.5467 4.10985 3.10985 3.5467 3.81647 3.24332C4.38322 3 5.09805 3 6.54902 3H7.04311C7.64819 3 8.22075 3.27394 8.60041 3.74509L10.4175 6M10.4175 6H16C17.4001 6 18.1002 6 18.635 6.27248C19.1054 6.51217 19.4878 6.89462 19.7275 7.36502C20 7.8998 20 8.59987 20 10V11M10.4175 6H7" /> <path d="M3.15802 15.5144L3.45643 14.7717C4.19029 12.9449 4.55723 12.0316 5.3224 11.5158C6.08757 11 7.07557 11 9.05157 11H17.1119C19.8004 11 21.1446 11 21.7422 11.8787C22.3397 12.7575 21.8405 14.0002 20.842 16.4856L20.5436 17.2283C19.8097 19.0551 19.4428 19.9684 18.6776 20.4842C17.9124 21 16.9244 21 14.9484 21H6.88812C4.19961 21 2.85535 21 2.25782 20.1213C1.66029 19.2425 2.15953 17.9998 3.15802 15.5144Z" /> </svg> ${formatSize(pdf.file_size_mb)}</span>
            <button class="btn btn-sm view-btn"
              style="background:var(--green-dim);color:var(--green);border:1px solid var(--green-border);"
              onclick="window.location.href='view.html?id=${pdf.id}'">
              View
            </button>
            <button class="btn btn-sm delete-btn"
              style="background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2);"
              data-id="${pdf.id}" data-title="${pdf.title}">
              üóëÔ∏è
            </button>
          </div>
        `

        // Delete button
        card.querySelector('.delete-btn').addEventListener('click', (e) => {
          e.stopPropagation()
          handleDelete(pdf.id, pdf.title, pdf.file_url, card)
        })

        gridEl.appendChild(card)
      })
    }

    // ‚îÄ‚îÄ Delete Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function handleDelete(pdfId, title, fileUrl, cardEl) {
      const confirmed = confirm(`Delete "${title}"?\n\nThis cannot be undone.`)
      if (!confirmed) return

      // Remove from DB
      const { error: dbErr } = await supabase
        .from('pdfs')
        .delete()
        .eq('id', pdfId)
        .eq('uploader_id', session.user.id)

      if (dbErr) {
        toast('Failed to delete. Try again.', 'error')
        return
      }

      // Remove from storage
      await supabase.storage.from('pdfs').remove([fileUrl])

      // Remove card from UI
      cardEl.style.opacity    = '0'
      cardEl.style.transform  = 'scale(0.95)'
      cardEl.style.transition = 'all 0.3s'
      setTimeout(() => cardEl.remove(), 300)

      toast(`"${title}" deleted`, 'success')

      // Show empty if no more cards
      const remaining = document.querySelectorAll('#uploads-grid .card').length
      if (remaining === 0) {
        document.getElementById('uploads-grid').style.display = 'none'
        document.getElementById('uploads-empty').style.display = 'block'
      }
    }

    // ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function bindEditModal() {
      const modal     = document.getElementById('edit-modal')
      const editBtn   = document.getElementById('edit-btn')
      const closeBtn  = document.getElementById('modal-close')
      const cancelBtn = document.getElementById('cancel-edit')

      // Open modal
      editBtn.addEventListener('click', async () => {
        modal.style.display = 'flex'
        document.body.style.overflow = 'hidden'

        // Pre-fill
        document.getElementById('edit-name').value = profile.full_name
        if (profile.universities) {
          document.getElementById('edit-uni-search').value =
            `${profile.universities.name} (${profile.universities.short_name})`
          document.getElementById('edit-uni-id').value = profile.university_id
        }

        await buildUniDropdown('edit-uni-search', 'edit-uni-dropdown', 'edit-uni-id')
      })

      // Close modal
      const closeModal = () => {
        modal.style.display = 'none'
        document.body.style.overflow = ''
        document.getElementById('edit-error').style.display   = 'none'
        document.getElementById('edit-success').style.display = 'none'
      }

      closeBtn.addEventListener('click', closeModal)
      cancelBtn.addEventListener('click', closeModal)
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal() })

      // Save
      document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault()

        const name  = document.getElementById('edit-name').value.trim()
        const uniId = document.getElementById('edit-uni-id').value

        document.getElementById('edit-name-error').textContent = ''
        document.getElementById('edit-error').style.display    = 'none'
        document.getElementById('edit-success').style.display  = 'none'

        if (!name || name.split(' ').length < 2) {
          document.getElementById('edit-name-error').textContent = 'Enter your full name'
          return
        }

        // Loading
        const saveBtn     = document.getElementById('save-btn')
        const saveText    = document.getElementById('save-text')
        const saveSpinner = document.getElementById('save-spinner')
        saveBtn.disabled        = true
        saveText.style.display  = 'none'
        saveSpinner.style.display = 'inline-block'

        const updates = { full_name: name }
        if (uniId) updates.university_id = uniId

        const { error } = await supabase
          .from('profiles')
          .update(updates)
          .eq('id', session.user.id)

        saveBtn.disabled        = false
        saveText.style.display  = 'inline'
        saveSpinner.style.display = 'none'

        if (error) {
          document.getElementById('edit-error').style.display = 'block'
          document.getElementById('edit-error').textContent   = error.message
          return
        }

        // Update UI
        document.getElementById('profile-name').textContent = name
        const initials = name.split(' ').slice(0, 2).map(n => n[0].toUpperCase()).join('')
        document.getElementById('profile-avatar').textContent = initials
        document.getElementById('nav-username').textContent   = name.split(' ')[0]

        document.getElementById('edit-success').style.display = 'block'
        document.getElementById('edit-success').textContent   = '‚úÖ Profile updated!'
        toast('Profile updated! üéâ', 'success')

        // Reload profile data
        await loadProfile()
        setTimeout(closeModal, 1200)
      })
    }

    init()
  </script>

</body>
</html>
