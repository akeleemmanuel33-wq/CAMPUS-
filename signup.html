<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up — Campus</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/auth.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- PAGE -->
  <main class="auth-page">
    <div class="auth-card card">

      <!-- LOGO -->
      <div class="auth-logo">
        <img src="logo.png" class="navbar-logo" style="width:52px;height:52px;font-size:26px;border-radius:14px;">
        <h1 class="auth-title">Join Campus</h1>
        <p class="auth-sub">Free account for Nigerian students</p>
      </div>

      <!-- TABS -->
      <div class="auth-tabs">
        <a href="login.html" class="auth-tab">Log In</a>
        <a href="signup.html" class="auth-tab active">Sign Up</a>
      </div>

      <!-- FORM -->
      <form id="signup-form" novalidate>

        <!-- Full Name -->
        <div class="input-group">
          <label class="input-label" for="fullname">Full Name</label>
          <input class="input" type="text" id="fullname" placeholder="e.g. Adaeze Okonkwo" required />
          <span class="field-error" id="fullname-error"></span>
        </div>

        <!-- Email -->
        <div class="input-group" style="margin-top:16px;">
          <label class="input-label" for="email">Email Address</label>
          <input class="input" type="email" id="email" placeholder="you@university.edu.ng" required />
          <span class="field-error" id="email-error"></span>
        </div>

        <!-- University -->
        <div class="input-group" style="margin-top:16px;">
          <label class="input-label">University</label>
          <div class="uni-dropdown-wrap">
            <input class="input" type="text" id="uni-search" placeholder="Search your university..." autocomplete="off" />
            <div class="uni-dropdown" id="uni-dropdown"></div>
            <input type="hidden" id="uni-id" />
          </div>
          <span class="field-error" id="uni-error"></span>
        </div>

        <!-- Password -->
        <div class="input-group" style="margin-top:16px;">
          <label class="input-label" for="password">Password</label>
          <div class="password-wrap">
            <input class="input" type="password" id="password" placeholder="At least 8 characters" required />
            <button type="button" class="toggle-pw" id="toggle-pw" aria-label="Toggle password">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#fff" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round"> <path d="M2 8C2 8 6.47715 3 12 3C17.5228 3 22 8 22 8" /> <path d="M21.544 13.045C21.848 13.4713 22 13.6845 22 14C22 14.3155 21.848 14.5287 21.544 14.955C20.1779 16.8706 16.6892 21 12 21C7.31078 21 3.8221 16.8706 2.45604 14.955C2.15201 14.5287 2 14.3155 2 14C2 13.6845 2.15201 13.4713 2.45604 13.045C3.8221 11.1294 7.31078 7 12 7C16.6892 7 20.1779 11.1294 21.544 13.045Z" /> <path d="M15 14C15 12.3431 13.6569 11 12 11C10.3431 11 9 12.3431 9 14C9 15.6569 10.3431 17 12 17C13.6569 17 15 15.6569 15 14Z" /> </svg>
            </button>
          </div>
          <span class="field-error" id="password-error"></span>
        </div>

        <!-- Confirm Password -->
        <div class="input-group" style="margin-top:16px;">
          <label class="input-label" for="confirm">Confirm Password</label>
          <div class="password-wrap">
            <input class="input" type="password" id="confirm" placeholder="Repeat your password" required />
            <button type="button" class="toggle-confirm" id="toggle-confirm" aria-label="Toggle password"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#fff" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"> <path d="M2 8C2 8 6.47715 3 12 3C17.5228 3 22 8 22 8" /> <path d="M21.544 13.045C21.848 13.4713 22 13.6845 22 14C22 14.3155 21.848 14.5287 21.544 14.955C20.1779 16.8706 16.6892 21 12 21C7.31078 21 3.8221 16.8706 2.45604 14.955C2.15201 14.5287 2 14.3155 2 14C2 13.6845 2.15201 13.4713 2.45604 13.045C3.8221 11.1294 7.31078 7 12 7C16.6892 7 20.1779 11.1294 21.544 13.045Z" /> <path d="M15 14C15 12.3431 13.6569 11 12 11C10.3431 11 9 12.3431 9 14C9 15.6569 10.3431 17 12 17C13.6569 17 15 15.6569 15 14Z" /> </svg></button>
          </div>
          <span class="field-error" id="confirm-error"></span>
        </div>

        <!-- Password strength -->
        <div style="margin-top:10px;">
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-dim);margin-bottom:5px;">
            <span>Password strength</span>
            <span id="strength-label">—</span>
          </div>
          <div class="progress-wrap">
            <div class="progress-fill" id="strength-bar" style="width:0%"></div>
          </div>
        </div>

        <!-- Terms -->
        <label class="terms-check" style="margin-top:20px;">
          <input type="checkbox" id="terms" />
          <span>I agree to the <a href="legal.html">Terms of Service</a> and <a href="legal.html">Privacy Policy</a></span>
        </label>
        <span class="field-error" id="terms-error"></span>

        <!-- Error banner -->
        <div class="alert alert-error" id="form-error" style="display:none;margin-top:18px;"></div>

        <!-- Success banner -->
        <div class="alert alert-success" id="form-success" style="display:none;margin-top:18px;"></div>

        <button class="btn btn-primary btn-full btn-lg" type="submit" id="submit-btn" style="margin-top:24px;">
          <span id="btn-text">Create Account →</span>
          <span id="btn-spinner" style="display:none;" class="btn-spinner"></span>
        </button>

      </form>

      <p class="auth-footer-text">
        Already have an account? <a href="login.html">Log in</a>
      </p>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { buildNav, buildFooter, buildUniDropdown, toast } from './js/ui.js'
    import { signUp, redirectIfLoggedIn } from './js/auth.js'

    await redirectIfLoggedIn()

    buildNav()
    buildFooter()

    // Build university dropdown
    await buildUniDropdown('uni-search', 'uni-dropdown', 'uni-id')

    // Toggle password visibility
    document.getElementById('toggle-pw').addEventListener('click', () => {
      const pw = document.getElementById('password')
      pw.type = pw.type === 'password' ? 'text' : 'password'
    })
    document.getElementById('toggle-confirm').addEventListener('click', () => {
      const pw = document.getElementById('confirm')
      pw.type = pw.type === 'password' ? 'text' : 'password'
    })

    // Password strength checker
    document.getElementById('password').addEventListener('input', (e) => {
      const val = e.target.value
      const bar = document.getElementById('strength-bar')
      const label = document.getElementById('strength-label')

      let score = 0
      if (val.length >= 8)  score++
      if (/[A-Z]/.test(val)) score++
      if (/[0-9]/.test(val)) score++
      if (/[^A-Za-z0-9]/.test(val)) score++

      const levels = [
        { w: '0%',   cls: '',        text: '—'        },
        { w: '25%',  cls: 'danger',  text: 'Weak'     },
        { w: '50%',  cls: 'warning', text: 'Fair'     },
        { w: '75%',  cls: '',        text: 'Good'     },
        { w: '100%', cls: '',        text: 'Strong ✓' },
      ]

      bar.style.width = levels[score].w
      bar.className = 'progress-fill ' + levels[score].cls
      label.textContent = levels[score].text
      label.style.color = score >= 3 ? 'var(--green)' : score >= 2 ? 'var(--orange)' : 'var(--red)'
    })

    // Form submit
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault()

      const fullName   = document.getElementById('fullname').value.trim()
      const email      = document.getElementById('email').value.trim()
      const uniId      = document.getElementById('uni-id').value
      const password   = document.getElementById('password').value
      const confirm    = document.getElementById('confirm').value
      const termsOk    = document.getElementById('terms').checked

      // Clear all errors
      ;['fullname','email','uni','password','confirm','terms'].forEach(f => {
        document.getElementById(`${f}-error`).textContent = ''
      })
      document.getElementById('form-error').style.display   = 'none'
      document.getElementById('form-success').style.display = 'none'

      // Validate
      let valid = true

      if (!fullName || fullName.split(' ').length < 2) {
        document.getElementById('fullname-error').textContent = 'Enter your full name (first and last)'
        valid = false
      }
      if (!email || !email.includes('@')) {
        document.getElementById('email-error').textContent = 'Enter a valid email address'
        valid = false
      }
      if (!uniId) {
        document.getElementById('uni-error').textContent = 'Please select your university'
        valid = false
      }
      if (password.length < 8) {
        document.getElementById('password-error').textContent = 'Password must be at least 8 characters'
        valid = false
      }
      if (password !== confirm) {
        document.getElementById('confirm-error').textContent = 'Passwords do not match'
        valid = false
      }
      if (!termsOk) {
        document.getElementById('terms-error').textContent = 'You must agree to the terms'
        valid = false
      }
      if (!valid) return

      // Loading state
      const btn     = document.getElementById('submit-btn')
      const btnText = document.getElementById('btn-text')
      const spinner = document.getElementById('btn-spinner')
      btn.disabled  = true
      btnText.style.display = 'none'
      spinner.style.display = 'inline-block'

      const { error } = await signUp({ fullName, email, password, universityId: uniId })

      btn.disabled = false
      btnText.style.display = 'inline'
      spinner.style.display = 'none'

      if (error) {
        const errEl = document.getElementById('form-error')
        errEl.style.display = 'block'
        if (error.message.includes('already registered')) {
          errEl.textContent = '⚠️ This email is already registered. Try logging in instead.'
        } else {
          errEl.textContent = error.message
        }
        return
      }

      // Show success — ask user to verify email
      document.getElementById('signup-form').style.display = 'none'
      const success = document.getElementById('form-success')
      success.style.display = 'block'
      success.innerHTML = `
        <strong>Account created!</strong><br/>
        We sent a verification email to <strong>${email}</strong>.<br/>
        Click the link in the email to activate your account, then log in.
      `
    })
  </script>

</body>
</html>
