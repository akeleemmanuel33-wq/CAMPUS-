<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View PDF â€” Campus</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/view.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- PAGE -->
  <main class="page">
    <div class="container-sm">

      <!-- BACK BUTTON -->
      <a href="index.html" class="back-btn">â† Back to Explore</a>

      <!-- LOADING STATE -->
      <div id="loading-wrap" class="loading-wrap">
        <div class="spinner"></div>
      </div>

      <!-- ERROR STATE -->
      <div id="error-wrap" style="display:none;">
        <div class="empty-state">
          <div class="empty-icon">ğŸ˜•</div>
          <h3>PDF not found</h3>
          <p>This PDF may have been removed or the link is broken</p>
          <a href="index.html" class="btn btn-primary" style="margin-top:20px;">Go back home</a>
        </div>
      </div>

      <!-- MAIN CONTENT â€” hidden until loaded -->
      <div id="pdf-content" style="display:none;">

        <!-- â”€â”€ PDF HEADER â”€â”€ -->
        <div class="card pdf-header">

          <!-- Badges row -->
          <div class="pdf-header-badges" id="pdf-badges"></div>

          <!-- Title -->
          <h1 class="pdf-title" id="pdf-title"></h1>

          <!-- Meta grid -->
          <div class="pdf-meta-grid">
            <div class="pdf-meta-item">
              <span class="pdf-meta-label">Uploaded by</span>
              <span class="pdf-meta-value" id="pdf-uploader"></span>
            </div>
            <div class="pdf-meta-item">
              <span class="pdf-meta-label">University</span>
              <span class="pdf-meta-value" id="pdf-university"></span>
            </div>
            <div class="pdf-meta-item">
              <span class="pdf-meta-label">File Size</span>
              <span class="pdf-meta-value" id="pdf-size"></span>
            </div>
            <div class="pdf-meta-item">
              <span class="pdf-meta-label">Uploaded</span>
              <span class="pdf-meta-value" id="pdf-date"></span>
            </div>
            <div class="pdf-meta-item">
              <span class="pdf-meta-label">Downloads</span>
              <span class="pdf-meta-value" id="pdf-downloads"></span>
            </div>
            <div class="pdf-meta-item">
              <span class="pdf-meta-label">Type</span>
              <span class="pdf-meta-value" id="pdf-type"></span>
            </div>
          </div>

          <div class="divider"></div>

          <!-- VIEW PROGRESS (shown when downloads locked) -->
          <div id="view-progress-wrap" style="display:none;">
            <div class="view-progress-box alert alert-warning">
              <div class="view-progress-top">
                <span id="view-progress-msg"></span>
                <span class="view-progress-count" id="view-progress-count"></span>
              </div>
              <div class="progress-wrap" style="margin-top:10px;">
                <div class="progress-fill warning" id="view-progress-bar" style="width:0%"></div>
              </div>
            </div>
          </div>

          <!-- DOWNLOAD BUTTON -->
          <button class="btn btn-primary btn-full btn-lg" id="download-btn" disabled>
            â³ Loading...
          </button>

          <!-- Share row -->
          <div class="share-row">
            <span class="share-label">Share:</span>
            <button class="btn btn-ghost btn-sm" id="copy-link-btn">ğŸ”— Copy Link</button>
            <button class="btn btn-ghost btn-sm" id="share-wa-btn">ğŸ’¬ WhatsApp</button>
          </div>

        </div>

        <!-- â”€â”€ PDF PREVIEW â”€â”€ -->
        <div class="card pdf-preview-card">
          <h2 class="section-title" style="padding:24px 24px 0;">Preview</h2>
          <div class="pdf-preview-wrap" id="pdf-preview-wrap">
            <div class="pdf-preview-placeholder">
              <div style="font-size:56px;margin-bottom:16px;">ğŸ“„</div>
              <p style="font-weight:600;font-size:16px;" id="preview-title-text"></p>
              <p style="color:var(--text-dim);font-size:13px;margin-top:8px;">
                Download the PDF to view its full contents
              </p>
            </div>
          </div>
        </div>

        <!-- â”€â”€ SIMILAR PDFs â”€â”€ -->
        <div id="similar-section" style="display:none;">
          <h2 class="section-title" style="margin-top:48px;">Similar PDFs</h2>
          <p class="section-sub">From the same university or subject area</p>
          <div class="pdf-grid" id="similar-grid"></div>
        </div>

      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { supabase }                    from './js/supabase.js'
    import { buildNav, buildFooter, toast,
             formatDate, formatSize,
             uniBadgeClass }               from './js/ui.js'
    import { getSession, hasViewedEnough } from './js/auth.js'

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let session    = null
    let pdf        = null
    let canDownload = false
    let viewCount   = 0

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      session = await getSession()
      await buildNav('')
      buildFooter()

      // Get PDF id from URL ?id=xxxx
      const params = new URLSearchParams(window.location.search)
      const pdfId  = params.get('id')

      if (!pdfId) {
        showError()
        return
      }

      await loadPdf(pdfId)
    }

    // â”€â”€ Load PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadPdf(pdfId) {
      const { data, error } = await supabase
        .from('pdfs')
        .select(`
          id, title, type, file_url, file_size_mb,
          download_count, created_at, is_approved,
          profiles ( id, full_name ),
          universities ( id, name, short_name, type )
        `)
        .eq('id', pdfId)
        .eq('is_approved', true)
        .single()

      if (error || !data) {
        showError()
        return
      }

      pdf = data
      document.title = `${pdf.title} â€” Campus`

      // Log the view if logged in
      if (session) {
        await logView()
        await checkDownloadAccess()
      }

      renderPdf()
      await loadSimilar()
    }

    // â”€â”€ Log View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function logView() {
      // Avoid duplicate view logs for same session
      const key = `viewed_${pdf.id}`
      if (sessionStorage.getItem(key)) return
      sessionStorage.setItem(key, '1')

      await supabase.from('download_logs').insert({
        user_id: session.user.id,
        pdf_id:  pdf.id,
        action:  'view'
      })

      // Increment profile views counter
      await supabase.rpc('increment_views', { uid: session.user.id })
    }

    // â”€â”€ Check download access â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkDownloadAccess() {
      const { count } = await supabase
        .from('download_logs')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', session.user.id)
        .eq('action', 'view')

      viewCount   = count || 0
      canDownload = viewCount >= 10
    }

    // â”€â”€ Render PDF page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPdf() {
      // Hide loader, show content
      document.getElementById('loading-wrap').style.display = 'none'
      document.getElementById('pdf-content').style.display  = 'block'

      const uni     = pdf.universities
      const uniName = uni ? `${uni.name} (${uni.short_name})` : 'â€”'
      const uniType = uni?.type || 'Federal'

      // Badges
      document.getElementById('pdf-badges').innerHTML = `
        <span class="badge ${pdf.type === 'Material' ? 'badge-material' : 'badge-past'}">
          ${pdf.type === 'Material' ? 'ğŸ“š' : 'ğŸ“'} ${pdf.type}
        </span>
        <span class="badge ${uniBadgeClass(uniType)}">${uniType}</span>
      `

      // Text fields
      document.getElementById('pdf-title').textContent      = pdf.title
      document.getElementById('pdf-uploader').textContent   = pdf.profiles?.full_name || 'Anonymous'
      document.getElementById('pdf-university').textContent = uniName
      document.getElementById('pdf-size').textContent       = formatSize(pdf.file_size_mb)
      document.getElementById('pdf-date').textContent       = formatDate(pdf.created_at)
      document.getElementById('pdf-downloads').textContent  = `${pdf.download_count || 0} downloads`
      document.getElementById('pdf-type').textContent       = pdf.type
      document.getElementById('preview-title-text').textContent = pdf.title

      // Download button state
      renderDownloadBtn()

      // Share buttons
      bindShareButtons()
    }

    // â”€â”€ Render Download Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderDownloadBtn() {
      const btn = document.getElementById('download-btn')
      const progressWrap = document.getElementById('view-progress-wrap')

      if (!session) {
        btn.disabled     = false
        btn.textContent  = 'ğŸ”’ Log in to Download'
        btn.onclick      = () => window.location.href = `login.html?next=view.html%3Fid%3D${pdf.id}`
        return
      }

      if (!canDownload) {
        const remaining = 10 - viewCount
        btn.disabled    = true
        btn.innerHTML   = `ğŸ”’ View ${remaining} more PDF${remaining !== 1 ? 's' : ''} to unlock`

        // Show progress bar
        progressWrap.style.display = 'block'
        document.getElementById('view-progress-msg').textContent =
          `You need to view 10 PDFs before downloading. Keep exploring!`
        document.getElementById('view-progress-count').textContent =
          `${viewCount} / 10`
        document.getElementById('view-progress-bar').style.width =
          `${(viewCount / 10) * 100}%`
        return
      }

      // Fully unlocked
      progressWrap.style.display = 'none'
      btn.disabled   = false
      btn.innerHTML  = 'â¬‡ï¸ Download PDF'
      btn.onclick    = handleDownload
    }

    // â”€â”€ Handle Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleDownload() {
      const btn = document.getElementById('download-btn')
      btn.disabled  = true
      btn.innerHTML = 'â³ Preparing download...'

      // Log download
      await supabase.from('download_logs').insert({
        user_id: session.user.id,
        pdf_id:  pdf.id,
        action:  'download'
      })

      // Increment counter via RPC
      await supabase.rpc('increment_download', { pid: pdf.id })

      // Get public URL and trigger download
      const { data } = supabase.storage.from('pdfs').getPublicUrl(pdf.file_url)

      const a      = document.createElement('a')
      a.href       = data.publicUrl
      a.download   = pdf.title + '.pdf'
      a.target     = '_blank'
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)

      toast(`Downloading "${pdf.title}" ğŸ“¥`, 'success')

      // Update download count display
      pdf.download_count = (pdf.download_count || 0) + 1
      document.getElementById('pdf-downloads').textContent = `${pdf.download_count} downloads`

      btn.disabled  = false
      btn.innerHTML = 'â¬‡ï¸ Download PDF'
    }

    // â”€â”€ Share Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindShareButtons() {
      const url = window.location.href

      document.getElementById('copy-link-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(url).then(() => {
          toast('Link copied to clipboard! ğŸ”—', 'success')
        })
      })

      document.getElementById('share-wa-btn').addEventListener('click', () => {
        const text = `Check out this PDF on Campus: ${pdf.title}\n${url}`
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank')
      })
    }

    // â”€â”€ Load Similar PDFs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSimilar() {
      if (!pdf.universities?.id) return

      const { data } = await supabase
        .from('pdfs')
        .select(`
          id, title, type, file_size_mb,
          download_count, created_at,
          profiles ( full_name ),
          universities ( name, short_name, type )
        `)
        .eq('is_approved', true)
        .eq('universities.id', pdf.universities.id)
        .neq('id', pdf.id)
        .limit(4)

      if (!data || data.length === 0) return

      const section = document.getElementById('similar-section')
      const grid    = document.getElementById('similar-grid')
      section.style.display = 'block'

      data.forEach(p => {
        const uniType  = p.universities?.type || 'Federal'
        const uniName  = p.universities ? `${p.universities.name} (${p.universities.short_name})` : 'â€”'

        const card = document.createElement('div')
        card.className = 'card card-hover pdf-card'
        card.style.cursor = 'pointer'
        card.innerHTML = `
          <div class="pdf-card-meta">
            <span class="badge ${p.type === 'Material' ? 'badge-material' : 'badge-past'}">
              ${p.type === 'Material' ? 'ğŸ“š' : 'ğŸ“'} ${p.type}
            </span>
            <span class="badge ${uniBadgeClass(uniType)}">${uniType}</span>
          </div>
          <h3 class="pdf-card-title">${p.title}</h3>
          <p class="pdf-card-uni">ğŸ« ${uniName}</p>
          <p class="pdf-card-info">ğŸ‘¤ ${p.profiles?.full_name || 'Anonymous'} Â· ğŸ“… ${formatDate(p.created_at)}</p>
          <div class="pdf-card-footer">
            <span class="pdf-card-stats">â¬‡ï¸ ${p.download_count || 0} Â· ğŸ“ ${formatSize(p.file_size_mb)}</span>
            <span class="btn btn-sm" style="background:var(--green-dim);color:var(--green);border:1px solid var(--green-border);">View â†’</span>
          </div>
        `
        card.addEventListener('click', () => {
          window.location.href = `view.html?id=${p.id}`
        })
        grid.appendChild(card)
      })
    }

    // â”€â”€ Error State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showError() {
      document.getElementById('loading-wrap').style.display = 'none'
      document.getElementById('error-wrap').style.display  = 'block'
    }

    init()
  </script>

</body>
</html>
