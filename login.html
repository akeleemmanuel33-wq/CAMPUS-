<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Log In ‚Äî Campus</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/auth.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- PAGE -->
  <main class="auth-page">
    <div class="auth-card card">

      <!-- LOGO -->
      <div class="auth-logo">
        <div class="navbar-logo" style="width:52px;height:52px;font-size:26px;border-radius:14px;">üìö</div>
        <h1 class="auth-title">Welcome back</h1>
        <p class="auth-sub">Log in to access Campus</p>
      </div>

      <!-- TABS -->
      <div class="auth-tabs">
        <a href="login.html" class="auth-tab active">Log In</a>
        <a href="signup.html" class="auth-tab">Sign Up</a>
      </div>

      <!-- FORM -->
      <form id="login-form" novalidate>

        <div class="input-group">
          <label class="input-label" for="email">Email Address</label>
          <input class="input" type="email" id="email" placeholder="you@university.edu.ng" required />
          <span class="field-error" id="email-error"></span>
        </div>

        <div class="input-group" style="margin-top:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <label class="input-label" for="password">Password</label>
            <a href="forgot.html" class="forgot-link">Forgot password?</a>
          </div>
          <div class="password-wrap">
            <input class="input" type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
            <button type="button" class="toggle-pw" id="toggle-pw" aria-label="Toggle password">üëÅ</button>
          </div>
          <span class="field-error" id="password-error"></span>
        </div>

        <!-- ERROR BANNER -->
        <div class="alert alert-error" id="form-error" style="display:none;margin-top:18px;"></div>

        <button class="btn btn-primary btn-full btn-lg" type="submit" id="submit-btn" style="margin-top:24px;">
          <span id="btn-text">Log In ‚Üí</span>
          <span id="btn-spinner" style="display:none;" class="btn-spinner"></span>
        </button>

      </form>

      <p class="auth-footer-text">
        Don't have an account? <a href="signup.html">Sign up free</a>
      </p>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { buildNav, buildFooter, toast } from './js/ui.js'
    import { logIn, redirectIfLoggedIn } from './js/auth.js'

    // Redirect if already logged in
    await redirectIfLoggedIn()

    // Build shared UI
    buildNav()
    buildFooter()

    // Toggle password visibility
    document.getElementById('toggle-pw').addEventListener('click', () => {
      const pw = document.getElementById('password')
      pw.type = pw.type === 'password' ? 'text' : 'password'
    })

    // Form submit
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault()

      const email    = document.getElementById('email').value.trim()
      const password = document.getElementById('password').value

      // Clear errors
      document.getElementById('email-error').textContent = ''
      document.getElementById('password-error').textContent = ''
      document.getElementById('form-error').style.display = 'none'

      // Basic validation
      let valid = true
      if (!email) {
        document.getElementById('email-error').textContent = 'Email is required'
        valid = false
      }
      if (!password) {
        document.getElementById('password-error').textContent = 'Password is required'
        valid = false
      }
      if (!valid) return

      // Show loading state
      const btn     = document.getElementById('submit-btn')
      const btnText = document.getElementById('btn-text')
      const spinner = document.getElementById('btn-spinner')
      btn.disabled  = true
      btnText.style.display  = 'none'
      spinner.style.display  = 'inline-block'

      // Call Supabase
      const { error } = await logIn({ email, password })

      if (error) {
        btn.disabled = false
        btnText.style.display = 'inline'
        spinner.style.display = 'none'

        const errEl = document.getElementById('form-error')
        errEl.style.display = 'block'

        if (error.message.includes('Invalid login')) {
          errEl.textContent = '‚ùå Incorrect email or password. Please try again.'
        } else if (error.message.includes('Email not confirmed')) {
          errEl.textContent = 'üìß Please verify your email before logging in.'
        } else {
          errEl.textContent = error.message
        }
        return
      }

      // Success ‚Äî check for redirect
      toast('Welcome back! üéì', 'success')
      const params = new URLSearchParams(window.location.search)
      const next   = params.get('next') || 'index.html'
      setTimeout(() => window.location.href = next, 800)
    })
  </script>

</body>
</html>
