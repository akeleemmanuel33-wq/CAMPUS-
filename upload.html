<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload PDF â€” Campus</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/upload.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- PAGE -->
  <main class="page">
    <div class="container-sm">

      <!-- PAGE HEADER -->
      <div class="page-header">
        <h1 class="page-title">Upload PDF</h1>
        <p class="page-sub">Share your materials with thousands of Nigerian students</p>
      </div>

      <!-- â”€â”€ ACCESS GATE (shown if under 10 views) â”€â”€ -->
      <div id="access-gate" style="display:none;">
        <div class="alert alert-warning gate-box">
          <div class="gate-icon">ğŸ”’</div>
          <h3 class="gate-title">Unlock Uploads</h3>
          <p class="gate-desc">
            You need to view at least <strong>5 PDFs</strong> before you can upload.
            This keeps Campus spam-free and ensures everyone contributes fairly.
          </p>
          <div class="gate-progress">
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;">
              <span>PDFs Viewed</span>
              <span id="gate-count" style="font-weight:700;color:var(--orange);">0 / 5</span>
            </div>
            <div class="progress-wrap">
              <div class="progress-fill warning" id="gate-bar" style="width:0%"></div>
            </div>
          </div>
          <a href="index.html" class="btn btn-primary" style="margin-top:20px;width:100%;justify-content:center;">
            ğŸ“š Go Explore PDFs
          </a>
        </div>
      </div>

      <!-- â”€â”€ LIMIT REACHED (shown if 10 uploads used) â”€â”€ -->
      <div id="limit-gate" style="display:none;">
        <div class="alert alert-error gate-box">
          <div class="gate-icon">ğŸ“µ</div>
          <h3 class="gate-title">Monthly Limit Reached</h3>
          <p class="gate-desc">
            You've used all <strong>10 uploads</strong> for this month.
            Your limit resets on the 1st of next month.
          </p>
          <a href="index.html" class="btn btn-ghost" style="margin-top:20px;width:100%;justify-content:center;">
            â† Back to Explore
          </a>
        </div>
      </div>

      <!-- â”€â”€ UPLOAD FORM â”€â”€ -->
      <div id="upload-wrap" style="display:none;">

        <!-- Monthly usage tracker -->
        <div class="usage-card card">
          <div class="usage-row">
            <div>
              <p class="usage-label">Monthly Uploads</p>
              <p class="usage-sub">Resets on the 1st of every month</p>
            </div>
            <span class="usage-count" id="usage-count">0 / 5</span>
          </div>
          <div class="progress-wrap" style="margin-top:12px;">
            <div class="progress-fill" id="usage-bar" style="width:0%"></div>
          </div>
        </div>

        <!-- Form card -->
        <form id="upload-form" class="card upload-form" novalidate>

          <!-- PDF Title -->
          <div class="input-group">
            <label class="input-label" for="pdf-title">ğŸ“„ PDF Title *</label>
            <input
              class="input" type="text" id="pdf-title"
              placeholder="e.g. PHY 101 Past Questions 2019â€“2023"
              maxlength="120" required
            />
            <div style="display:flex;justify-content:space-between;margin-top:4px;">
              <span class="field-error" id="title-error"></span>
              <span class="char-count" id="title-count">0 / 120</span>
            </div>
          </div>

          <!-- University -->
          <div class="input-group">
            <label class="input-label">ğŸ« University *</label>
            <div class="uni-dropdown-wrap">
              <input
                class="input" type="text" id="uni-search"
                placeholder="Search your university..."
                autocomplete="off"
              />
              <div class="uni-dropdown" id="uni-dropdown"></div>
              <input type="hidden" id="uni-id" />
            </div>
            <span class="field-error" id="uni-error"></span>
          </div>

          <!-- Course Code (optional) -->
          <div class="input-group">
            <label class="input-label" for="course-code">
              ğŸ“Œ Course Code
              <span class="optional-tag">optional</span>
            </label>
            <input
              class="input" type="text" id="course-code"
              placeholder="e.g. PHY 101, MTH 201, CSC 301"
              maxlength="20"
            />
          </div>

          <!-- Type -->
          <div class="input-group">
            <label class="input-label">ğŸ·ï¸ Type *</label>
            <div class="type-toggle">
              <button type="button" class="type-btn active" data-type="Material">
                <span class="type-icon">ğŸ“š</span>
                <span class="type-name">Material</span>
                <span class="type-desc">Lecture notes, textbooks, guides</span>
              </button>
              <button type="button" class="type-btn" data-type="Past Question">
                <span class="type-icon">ğŸ“</span>
                <span class="type-name">Past Question</span>
                <span class="type-desc">Exam questions, test papers</span>
              </button>
            </div>
            <input type="hidden" id="pdf-type" value="Material" />
          </div>

          <!-- File Upload -->
          <div class="input-group">
            <label class="input-label">ğŸ“¤ PDF File * <span class="optional-tag">Max 20MB</span></label>
            <div class="drop-zone" id="drop-zone">
              <input
                type="file" id="file-input"
                accept=".pdf,application/pdf"
                style="display:none;"
              />
              <div id="drop-idle" class="drop-idle">
                <div class="drop-icon">ğŸ“</div>
                <p class="drop-title">Drag & drop your PDF here</p>
                <p class="drop-sub">or <button type="button" id="browse-btn" class="browse-link">browse files</button></p>
                <p class="drop-hint">PDF only Â· Max 20MB</p>
              </div>
              <div id="drop-ready" class="drop-ready" style="display:none;">
                <div class="file-preview">
                  <div class="file-icon">ğŸ“„</div>
                  <div class="file-info">
                    <p class="file-name" id="file-name"></p>
                    <p class="file-size" id="file-size"></p>
                  </div>
                  <button type="button" id="remove-file" class="remove-file">âœ•</button>
                </div>
                <!-- Upload progress bar -->
                <div id="upload-progress-wrap" style="display:none;margin-top:12px;">
                  <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px;color:var(--text-muted);">
                    <span>Uploading...</span>
                    <span id="upload-pct">0%</span>
                  </div>
                  <div class="progress-wrap">
                    <div class="progress-fill" id="upload-progress-bar" style="width:0%;transition:width 0.3s;"></div>
                  </div>
                </div>
              </div>
            </div>
            <span class="field-error" id="file-error"></span>
          </div>

          <!-- Error banner -->
          <div class="alert alert-error" id="form-error" style="display:none;"></div>

          <!-- Submit -->
          <button class="btn btn-primary btn-full btn-lg" type="submit" id="submit-btn">
            <span id="btn-text">ğŸš€ Upload PDF</span>
            <span id="btn-spinner" class="btn-spinner" style="display:none;"></span>
          </button>

          <p class="upload-terms">
            By uploading, you confirm this file doesn't violate any copyright or academic policy.
            Inappropriate uploads will be removed and your account may be suspended.
          </p>

        </form>
      </div>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { supabase }                          from './js/supabase.js'
    import { buildNav, buildFooter, toast,
             buildUniDropdown }                  from './js/ui.js'
    import { requireAuth, canUpload, isAdmin }   from './js/auth.js'

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let session     = null
    let profile     = null
    let selectedFile = null
    let selectedType = 'Material'

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      // requireAuth redirects to login if not logged in
      session = await requireAuth()
      if (!session) return

      await buildNav('upload')
      buildFooter()

      // Load profile
      const { data } = await supabase
        .from('profiles')
        .select('*, universities(name, short_name)')
        .eq('id', session.user.id)
        .single()

      profile = data

      // Check if admin â€” admins bypass the 10-view rule
      const admin = await isAdmin(session.user.id)

      // Check views (skipped for admins)
      let views = 0
      if (!admin) {
        const { count: viewCount } = await supabase
          .from('download_logs')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', session.user.id)
          .eq('action', 'view')
        views = viewCount || 0
      }

      // Check upload limit
      const uploadOk = await canUpload(profile)

      if (!admin && views < 5) {
        // Show access gate
        document.getElementById('access-gate').style.display = 'block'
        document.getElementById('gate-count').textContent = `${views} / 5`
        document.getElementById('gate-bar').style.width   = `${(views / 5) * 100}%`
        return
      }

      if (!uploadOk) {
        document.getElementById('limit-gate').style.display = 'block'
        return
      }

      // All good â€” show form
      showForm()
    }

    // â”€â”€ Show Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showForm() {
      document.getElementById('upload-wrap').style.display = 'block'

      // Usage bar
      const used = profile.upload_count_this_month || 0
      document.getElementById('usage-count').textContent = `${used} / 10`
      document.getElementById('usage-bar').style.width   = `${(used / 10) * 100}%`
      if (used >= 8) {
        document.getElementById('usage-bar').classList.add('danger')
      }

      // Pre-fill university from profile
      if (profile.universities) {
        const uniInput = document.getElementById('uni-search')
        uniInput.value = `${profile.universities.name} (${profile.universities.short_name})`
        document.getElementById('uni-id').value = profile.university_id
      }

      buildUniDropdown('uni-search', 'uni-dropdown', 'uni-id')
      bindTypeToggle()
      bindFileUpload()
      bindCharCount()
      bindFormSubmit()
    }

    // â”€â”€ Type Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindTypeToggle() {
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'))
          btn.classList.add('active')
          selectedType = btn.dataset.type
          document.getElementById('pdf-type').value = selectedType
        })
      })
    }

    // â”€â”€ File Upload (drag & drop + browse) â”€â”€â”€â”€â”€â”€â”€
    function bindFileUpload() {
      const dropZone  = document.getElementById('drop-zone')
      const fileInput = document.getElementById('file-input')
      const browseBtn = document.getElementById('browse-btn')
      const removeBtn = document.getElementById('remove-file')

      browseBtn.addEventListener('click', () => fileInput.click())

      fileInput.addEventListener('change', () => {
        if (fileInput.files[0]) handleFile(fileInput.files[0])
      })

      // Drag & drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault()
        dropZone.classList.add('dragover')
      })
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover')
      })
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault()
        dropZone.classList.remove('dragover')
        const file = e.dataTransfer.files[0]
        if (file) handleFile(file)
      })

      removeBtn.addEventListener('click', () => {
        selectedFile = null
        fileInput.value = ''
        document.getElementById('drop-idle').style.display  = 'block'
        document.getElementById('drop-ready').style.display = 'none'
        document.getElementById('file-error').textContent   = ''
      })
    }

    function handleFile(file) {
      const fileError = document.getElementById('file-error')

      // Validate type
      if (file.type !== 'application/pdf' && !file.name.endsWith('.pdf')) {
        fileError.textContent = 'âŒ Only PDF files are allowed'
        return
      }

      // Validate size (20MB)
      const maxSize = 20 * 1024 * 1024
      if (file.size > maxSize) {
        fileError.textContent = `âŒ File too large (${(file.size/1024/1024).toFixed(1)}MB). Max is 20MB`
        return
      }

      fileError.textContent = ''
      selectedFile = file

      // Show file preview
      document.getElementById('drop-idle').style.display  = 'none'
      document.getElementById('drop-ready').style.display = 'block'
      document.getElementById('file-name').textContent    = file.name
      document.getElementById('file-size').textContent    = `${(file.size / 1024 / 1024).toFixed(2)} MB`
    }

    // â”€â”€ Char Count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindCharCount() {
      const titleInput = document.getElementById('pdf-title')
      const countEl   = document.getElementById('title-count')
      titleInput.addEventListener('input', () => {
        const len = titleInput.value.length
        countEl.textContent = `${len} / 120`
        countEl.style.color = len > 100 ? 'var(--orange)' : 'var(--text-dim)'
      })
    }

    // â”€â”€ Form Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindFormSubmit() {
      document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault()

        const title      = document.getElementById('pdf-title').value.trim()
        const uniId      = document.getElementById('uni-id').value
        const courseCode = document.getElementById('course-code').value.trim()
        const type       = document.getElementById('pdf-type').value

        // Clear errors
        document.getElementById('title-error').textContent = ''
        document.getElementById('uni-error').textContent   = ''
        document.getElementById('file-error').textContent  = ''
        document.getElementById('form-error').style.display = 'none'

        // Validate
        let valid = true
        if (!title) {
          document.getElementById('title-error').textContent = 'PDF title is required'
          valid = false
        }
        if (!uniId) {
          document.getElementById('uni-error').textContent = 'Please select a university'
          valid = false
        }
        if (!selectedFile) {
          document.getElementById('file-error').textContent = 'Please select a PDF file'
          valid = false
        }
        if (!valid) return

        // Loading state
        setLoading(true)

        try {
          // 1. Build unique file path
          const ext      = '.pdf'
          const safeName = title.replace(/[^a-z0-9]/gi, '_').toLowerCase()
          const filePath = `${session.user.id}/${Date.now()}_${safeName}${ext}`

          // 2. Show upload progress UI
          document.getElementById('upload-progress-wrap').style.display = 'block'

          // 3. Upload file to Supabase Storage
          const { error: storageError } = await supabase.storage
            .from('pdfs')
            .upload(filePath, selectedFile, {
              cacheControl: '3600',
              upsert: false,
              contentType: 'application/pdf',
            })

          if (storageError) throw storageError

          // Simulate progress fill after upload
          document.getElementById('upload-progress-bar').style.width = '100%'
          document.getElementById('upload-pct').textContent = '100%'

          // 4. Insert PDF record into DB
          const fullTitle = courseCode ? `${courseCode} â€” ${title}` : title

          const { error: dbError } = await supabase
            .from('pdfs')
            .insert({
              title:          fullTitle,
              university_id:  uniId,
              uploader_id:    session.user.id,
              type:           type,
              file_url:       filePath,
              file_size_mb:   parseFloat((selectedFile.size / 1024 / 1024).toFixed(2)),
              is_approved:    true,
            })

          if (dbError) throw dbError

          // 5. Increment monthly upload count
          await supabase
            .from('profiles')
            .update({ upload_count_this_month: (profile.upload_count_this_month || 0) + 1 })
            .eq('id', session.user.id)

          // 6. Success!
          toast('PDF uploaded successfully! ğŸ‰', 'success')
          setTimeout(() => window.location.href = 'index.html', 1500)

        } catch (err) {
          console.error(err)
          const errEl = document.getElementById('form-error')
          errEl.style.display = 'block'
          errEl.textContent = `Upload failed: ${err.message || 'Please try again.'}`
          setLoading(false)
          document.getElementById('upload-progress-wrap').style.display = 'none'
        }
      })
    }

    // â”€â”€ Loading State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setLoading(loading) {
      const btn     = document.getElementById('submit-btn')
      const btnText = document.getElementById('btn-text')
      const spinner = document.getElementById('btn-spinner')
      btn.disabled            = loading
      btnText.style.display   = loading ? 'none'         : 'inline'
      spinner.style.display   = loading ? 'inline-block' : 'none'
    }

    init()
  </script>

</body>
</html>
