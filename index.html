<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Campus â€” Nigeria's Student PDF Platform</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/index.css" />
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar" id="navbar"></nav>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HERO SECTION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="hero">
    <div class="hero-glow hero-glow-1"></div>
    <div class="hero-glow hero-glow-2"></div>

    <div class="container">
      <div class="hero-badge">ğŸ‡³ğŸ‡¬ For Nigerian Students</div>

      <h1 class="hero-title">
        Every Material.<br />
        <span class="hero-gradient">Every University.</span>
      </h1>

      <p class="hero-sub">
        Share and discover academic PDFs across all Nigerian universities.<br />
        Past questions, lecture notes â€” all in one place.
      </p>

      <!-- CTA BUTTONS â€” shown only when logged out -->
      <div id="hero-cta" style="display:none;justify-content:center;gap:14px;flex-wrap:wrap;margin-bottom:36px;">
        <a href="signup.html" class="btn btn-primary btn-lg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 8C2 9.34178 10.0949 13 11.9861 13C13.8772 13 21.9722 9.34178 21.9722 8C21.9722 6.65822 13.8772 3 11.9861 3C10.0949 3 2 6.65822 2 8Z" /> <path d="M5.99414 11L6.23925 16.6299C6.24415 16.7426 6.25634 16.8555 6.28901 16.9635C6.38998 17.2973 6.57608 17.6006 6.86 17.8044C9.08146 19.3985 14.8901 19.3985 17.1115 17.8044C17.3956 17.6006 17.5816 17.2973 17.6826 16.9635C17.7152 16.8555 17.7274 16.7426 17.7324 16.6299L17.9774 11" /> <path d="M20.4734 9.5V16.5M20.4734 16.5C19.6814 17.9463 19.3312 18.7212 18.9755 20C18.8983 20.455 18.9596 20.6843 19.2732 20.8879C19.4006 20.9706 19.5537 21 19.7055 21H21.2259C21.3876 21 21.5507 20.9663 21.6838 20.8745C21.9753 20.6735 22.0503 20.453 21.9713 20C21.6595 18.8126 21.2623 18.0008 20.4734 16.5Z" /> </svg> Create Free Account</a>
        <a href="login.html" class="btn btn-outline btn-lg">Log In</a>
      </div>

      <!-- SEARCH BAR -->
      <div class="search-bar-wrap">
        <div class="search-bar">
          <span class="search-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M15 15L16.5 16.5" /> <path d="M16.9333 19.0252C16.3556 18.4475 16.3556 17.5109 16.9333 16.9333C17.5109 16.3556 18.4475 16.3556 19.0252 16.9333L21.0667 18.9748C21.6444 19.5525 21.6444 20.4891 21.0667 21.0667C20.4891 21.6444 19.5525 21.6444 18.9748 21.0667L16.9333 19.0252Z" /> <path d="M16.5 9.5C16.5 5.63401 13.366 2.5 9.5 2.5C5.63401 2.5 2.5 5.63401 2.5 9.5C2.5 13.366 5.63401 16.5 9.5 16.5C13.366 16.5 16.5 13.366 16.5 9.5Z" /> </svg>
          </span>
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Search by title, course code, university..."
            autocomplete="off"
          />
          <button class="btn btn-primary" id="search-btn">
            <span class="search-btn-text">Search</span>
            <span class="search-btn-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 15L16.5 16.5" />
                <path d="M16.9333 19.0252C16.3556 18.4475 16.3556 17.5109 16.9333 16.9333C17.5109 16.3556 18.4475 16.3556 19.0252 16.9333L21.0667 18.9748C21.6444 19.5525 21.6444 20.4891 21.0667 21.0667C20.4891 21.6444 19.5525 21.6444 18.9748 21.0667L16.9333 19.0252Z" />
                <path d="M16.5 9.5C16.5 5.63401 13.366 2.5 9.5 2.5C5.63401 2.5 2.5 5.63401 2.5 9.5C2.5 13.366 5.63401 16.5 9.5 16.5C13.366 16.5 16.5 13.366 16.5 9.5Z" />
              </svg>
            </span>
          </button>
        </div>

        <!-- QUICK SEARCH SUGGESTIONS -->
        <div class="search-suggestions" id="suggestions"></div>
      </div>

      <!-- STATS ROW -->
      <div class="hero-stats">
        <div class="hero-stat">
          <span class="hero-stat-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M20 13V10.6569C20 9.83935 20 9.4306 19.8478 9.06306C19.6955 8.69552 19.4065 8.40649 18.8284 7.82843L14.0919 3.09188C13.593 2.593 13.3436 2.34355 13.0345 2.19575C12.9702 2.165 12.9044 2.13772 12.8372 2.11401C12.5141 2 12.1614 2 11.4558 2C8.21082 2 6.58831 2 5.48933 2.88607C5.26731 3.06508 5.06508 3.26731 4.88607 3.48933C4 4.58831 4 6.21082 4 9.45584V13M13 2.5V3C13 5.82843 13 7.24264 13.8787 8.12132C14.7574 9 16.1716 9 19 9H19.5" /> <path d="M19.75 16H17.25C16.6977 16 16.25 16.4477 16.25 17V19M16.25 19V22M16.25 19H19.25M4.25 22V19.5M4.25 19.5V16H6C6.9665 16 7.75 16.7835 7.75 17.75C7.75 18.7165 6.9665 19.5 6 19.5H4.25ZM10.25 16H11.75C12.8546 16 13.75 16.8954 13.75 18V20C13.75 21.1046 12.8546 22 11.75 22H10.25V16Z" /> </svg>
          </span>
          <span class="hero-stat-num" id="stat-pdfs">â€”</span>
          <span class="hero-stat-label">PDFs Shared</span>
        </div>
        <div class="hero-stat-divider"></div>
        <div class="hero-stat">
          <span class="hero-stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 22H21.5" /> <path d="M3 13V22M21 13V22" /> <path d="M7.5 8V22M16.5 8V22" /> <path d="M2 13H7M22 13H17" /> <path d="M6.5 8H17.5" /> <path d="M12 8V4.98221M12 4.98221V2.97035C12 2.49615 12 2.25905 12.1464 2.11173C12.6061 1.64939 14.5 2.74303 15.2203 3.18653C15.8285 3.56105 16 4.30914 16 4.98221H12Z" /> <path d="M12 22L12 20" /> <path d="M10.5 12L10.5 12.5M13.5 12V12.5" /> <path d="M10.5 16L10.5 16.5M13.5 16V16.5" /> </svg></span>
          <span class="hero-stat-num" id="stat-unis">â€”</span>
          <span class="hero-stat-label">Universities</span>
        </div>
        <div class="hero-stat-divider"></div>
        <div class="hero-stat">
          <span class="hero-stat-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" /> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" /> </svg> </span>
          <span class="hero-stat-num" id="stat-downloads">â€”</span>
          <span class="hero-stat-label">Downloads</span>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FILTERS + PDF GRID
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section class="browse-section">
    <div class="container">

      <!-- FILTER ROW -->
      <div class="filter-row">

        <!-- Type filter -->
        <div class="chip-group" id="type-filters">
          <button class="chip active" data-type="All">All</button>
          <button class="chip" data-type="Material"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M3 9H18C18.9319 9 19.3978 9 19.7654 9.15224C20.2554 9.35523 20.6448 9.74458 20.8478 10.2346C21 10.6022 21 11.0681 21 12C21 12.9319 21 13.3978 20.8478 13.7654C20.6448 14.2554 20.2554 14.6448 19.7654 14.8478C19.3978 15 18.9319 15 18 15H13" /> <path d="M6 15H3" /> <path d="M13 15H15C15.9319 15 16.3978 15 16.7654 15.1522C17.2554 15.3552 17.6448 15.7446 17.8478 16.2346C18 16.6022 18 17.0681 18 18C18 18.9319 18 19.3978 17.8478 19.7654C17.6448 20.2554 17.2554 20.6448 16.7654 20.8478C16.3978 21 15.9319 21 15 21H3" /> <path d="M3 3H14C14.9319 3 15.3978 3 15.7654 3.15224C16.2554 3.35523 16.6448 3.74458 16.8478 4.23463C17 4.60218 17 5.06812 17 6C17 6.93188 17 7.39782 16.8478 7.76537C16.6448 8.25542 16.2554 8.64477 15.7654 8.84776C15.3978 9 14.9319 9 14 9H3" /> <path d="M13 9L13 15.1905C13 16.3045 13 16.8616 12.6735 16.9803C12.3469 17.0991 11.9782 16.6761 11.2407 15.8303L10.7593 15.278C10.4064 14.8733 10.23 14.6709 10 14.6709C9.77003 14.6709 9.5936 14.8733 9.24074 15.278L8.75926 15.8303C8.02179 16.6761 7.65305 17.0991 7.32653 16.9803C7 16.8616 7 16.3045 7 15.1905L7 9" /> </svg> Material</button>
          <button class="chip" data-type="Past Question">ğŸ“ Past Question</button>
        </div>

        <div class="filter-divider"></div>

        <!-- University type filter -->
        <div class="chip-group" id="uni-filters">
          <button class="chip active" data-uni="All">All Schools</button>
          <button class="chip" data-uni="Federal">Federal</button>
          <button class="chip" data-uni="State">State</button>
          <button class="chip" data-uni="Private">Private</button>
        </div>

        <!-- Sort -->
        <div class="sort-wrap">
          <span class="sort-label">Sort:</span>
          <button class="chip active" id="sort-recent" data-sort="recent">Recent</button>
          <button class="chip" id="sort-popular" data-sort="popular">Popular</button>
        </div>

      </div>

      <!-- CATEGORY CHIPS -->
      <div class="category-row" id="category-row">
        <!-- Populated by JS -->
      </div>

      <!-- RESULTS META -->
      <div class="results-meta">
        <p id="results-count" class="results-count"></p>
        <div id="view-hint" class="view-hint" style="display:none;"></div>
      </div>

      <!-- PDF GRID -->
      <div class="pdf-grid" id="pdf-grid">
        <!-- Skeleton loaders shown while fetching -->
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>

      <!-- LOAD MORE -->
      <div style="text-align:center;margin-top:40px;">
        <button class="btn btn-ghost" id="load-more-btn" style="display:none;">
          Load More PDFs
        </button>
      </div>

    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { supabase }                          from './js/supabase.js'
    import { buildNav, buildFooter, toast,
             formatDate, formatSize,
             uniBadgeClass }                     from './js/ui.js'
    import { getSession, hasViewedEnough }       from './js/auth.js'

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let session       = null
    let profile       = null
    let allPdfs       = []
    let filtered      = []
    let activeType    = 'All'
    let activeUni     = 'All'
    let activeCategory= 'All'
    let activeSort    = 'recent'
    let searchQuery   = ''
    let page          = 0
    const PAGE_SIZE   = 12
    let canDownload   = false

    const CATEGORIES = [
      'All','Physics','Mathematics','Chemistry','Biology',
      'Computer Science','Law','Medicine','Economics',
      'Accounting','English','Engineering','Psychology','Other'
    ]

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      session = await getSession()
      await buildNav('home')
      buildFooter()
      buildCategoryChips()

      if (session) {
        canDownload = await hasViewedEnough(session.user.id)
        document.getElementById('view-hint').style.display = 'flex'
        updateViewHint()
      } else {
        // Show login/signup CTA in hero for logged-out users
        document.getElementById('hero-cta').style.display = 'flex'
      }

      await loadStats()
      await loadPdfs()
      bindFilters()
      bindSearch()
    }

    // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadStats() {
      const [{ count: pdfCount }, { count: uniCount }, { data: dlData }] = await Promise.all([
        supabase.from('pdfs').select('*', { count: 'exact', head: true }).eq('is_approved', true),
        supabase.from('universities').select('*', { count: 'exact', head: true }),
        supabase.from('pdfs').select('download_count').eq('is_approved', true)
      ])

      const totalDownloads = dlData?.reduce((sum, r) => sum + (r.download_count || 0), 0) || 0

      animateCount('stat-pdfs',      pdfCount       || 0)
      animateCount('stat-unis',      uniCount       || 0)
      animateCount('stat-downloads', totalDownloads    )
    }

    function animateCount(id, target) {
      const el = document.getElementById(id)
      if (!el) return
      let current = 0
      const step = Math.ceil(target / 40)
      const timer = setInterval(() => {
        current = Math.min(current + step, target)
        el.textContent = current.toLocaleString()
        if (current >= target) clearInterval(timer)
      }, 30)
    }

    // â”€â”€ Load PDFs from Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadPdfs(append = false) {
      if (!append) {
        page = 0
        showSkeletons()
      }

      let query = supabase
        .from('pdfs')
        .select(`
          id, title, type, file_url, file_size_mb,
          download_count, created_at,
          profiles ( full_name ),
          universities ( name, short_name, type )
        `)
        .eq('is_approved', true)

      if (searchQuery) {
        query = query.ilike('title', `%${searchQuery}%`)
      }
      if (activeType !== 'All') {
        query = query.eq('type', activeType)
      }
      if (activeUni !== 'All') {
        query = query.eq('universities.type', activeUni)
      }

      if (activeSort === 'popular') {
        query = query.order('download_count', { ascending: false })
      } else {
        query = query.order('created_at', { ascending: false })
      }

      query = query.range(page * PAGE_SIZE, (page + 1) * PAGE_SIZE - 1)

      const { data, error } = await query

      if (error) {
        toast('Failed to load PDFs. Please refresh.', 'error')
        clearSkeletons()
        return
      }

      // Client-side category + uni-type filter
      let results = data || []

      if (activeUni !== 'All') {
        results = results.filter(p => p.universities?.type === activeUni)
      }
      if (activeCategory !== 'All') {
        results = results.filter(p => {
          const title = p.title.toLowerCase()
          return title.includes(activeCategory.toLowerCase())
        })
      }

      if (!append) {
        allPdfs  = results
        filtered = results
      } else {
        allPdfs  = [...allPdfs, ...results]
        filtered = allPdfs
      }

      renderGrid(append)
      updateResultsMeta()

      const loadMoreBtn = document.getElementById('load-more-btn')
      loadMoreBtn.style.display = results.length === PAGE_SIZE ? 'inline-flex' : 'none'
    }

    // â”€â”€ Render Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderGrid(append = false) {
      const grid = document.getElementById('pdf-grid')

      if (!append) grid.innerHTML = ''

      if (!append && filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1">
            <div class="empty-icon">ğŸ“­</div>
            <h3>No PDFs found</h3>
            <p>Try a different search term or adjust the filters</p>
          </div>`
        return
      }

      filtered.forEach(pdf => {
        const card = document.createElement('div')
        card.className = 'card card-hover pdf-card'
        card.innerHTML = buildPdfCard(pdf)
        card.querySelector('.view-btn').addEventListener('click', () => handleView(pdf))
        card.querySelector('.dl-btn').addEventListener('click', () => handleDownload(pdf))
        grid.appendChild(card)
      })
    }

    function buildPdfCard(pdf) {
      const uniType  = pdf.universities?.type || 'Federal'
      const uniName  = pdf.universities ? `${pdf.universities.name} (${pdf.universities.short_name})` : 'â€”'
      const uploader = pdf.profiles?.full_name || 'Anonymous'
      const dlBtnStyle = canDownload
        ? 'background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;border:none;'
        : 'background:rgba(255,255,255,0.05);color:var(--text-dim);border:1px solid var(--border);'

      return `
        <div class="pdf-card-meta">
          <span class="badge ${pdf.type === 'Material' ? 'badge-material' : 'badge-past'}">
            ${pdf.type === 'Material' ? 'ğŸ“š' : 'ğŸ“'} ${pdf.type}
          </span>
          <span class="badge ${uniBadgeClass(uniType)}">${uniType}</span>
        </div>
        <h3 class="pdf-card-title">${pdf.title}</h3>
        <p style="display:flex; align-items:center; gap: 3px;" class="pdf-card-uni"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 20" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 22H21.5" /> <path d="M3 13V22M21 13V22" /> <path d="M7.5 8V22M16.5 8V22" /> <path d="M2 13H7M22 13H17" /> <path d="M6.5 8H17.5" /> <path d="M12 8V4.98221M12 4.98221V2.97035C12 2.49615 12 2.25905 12.1464 2.11173C12.6061 1.64939 14.5 2.74303 15.2203 3.18653C15.8285 3.56105 16 4.30914 16 4.98221H12Z" /> <path d="M12 22L12 20" /> <path d="M10.5 12L10.5 12.5M13.5 12V12.5" /> <path d="M10.5 16L10.5 16.5M13.5 16V16.5" /> </svg> ${uniName}</p>
        <p class="pdf-card-info"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M15 2.4578C14.053 2.16035 13.0452 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 10.9548 21.8396 9.94704 21.5422 9" /> <path d="M15 10C15 11.6569 13.6569 13 12 13C10.3431 13 9 11.6569 9 10C9 8.34315 10.3431 7 12 7C13.6569 7 15 8.34315 15 10Z" /> <path d="M5.49994 19.5001L6.06034 18.5194C6.95055 16.9616 8.60727 16.0001 10.4016 16.0001H13.5983C15.3926 16.0001 17.0493 16.9616 17.9395 18.5194L18.4999 19.5001" /> <path d="M18.9737 2.02148C18.9795 1.99284 19.0205 1.99284 19.0263 2.02148C19.3302 3.50808 20.4919 4.66984 21.9785 4.97368C22.0072 4.97954 22.0072 5.02046 21.9785 5.02632C20.4919 5.33016 19.3302 6.49192 19.0263 7.97852C19.0205 8.00716 18.9795 8.00716 18.9737 7.97852C18.6698 6.49192 17.5081 5.33016 16.0215 5.02632C15.9928 5.02046 15.9928 4.97954 16.0215 4.97368C17.5081 4.66984 18.6698 3.50808 18.9737 2.02148Z" /> </svg> ${uploader} &nbsp;Â·&nbsp; <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M16 2V6M8 2V6" /> <path d="M13 4H11C7.22876 4 5.34315 4 4.17157 5.17157C3 6.34315 3 8.22876 3 12V14C3 17.7712 3 19.6569 4.17157 20.8284C5.34315 22 7.22876 22 11 22H13C16.7712 22 18.6569 22 19.8284 20.8284C21 19.6569 21 17.7712 21 14V12C21 8.22876 21 6.34315 19.8284 5.17157C18.6569 4 16.7712 4 13 4Z" /> <path d="M3 10H21" /> <path d="M11 14H16M8 14H8.00898M13 18H8M16 18H15.991" /> </svg> ${formatDate(pdf.created_at)}</p>
        <div style="display:flex; align-items:center; gap: 3px;" class="pdf-card-footer">
          <span class="pdf-card-stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" /> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" /> </svg>  ${pdf.download_count || 0} &nbsp;Â·&nbsp; <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" color="currentColor" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 19V7.54902C2 6.10516 2 5.38322 2.24332 4.81647C2.5467 4.10985 3.10985 3.5467 3.81647 3.24332C4.38322 3 5.09805 3 6.54902 3H7.04311C7.64819 3 8.22075 3.27394 8.60041 3.74509L10.4175 6M10.4175 6H16C17.4001 6 18.1002 6 18.635 6.27248C19.1054 6.51217 19.4878 6.89462 19.7275 7.36502C20 7.8998 20 8.59987 20 10V11M10.4175 6H7" /> <path d="M3.15802 15.5144L3.45643 14.7717C4.19029 12.9449 4.55723 12.0316 5.3224 11.5158C6.08757 11 7.07557 11 9.05157 11H17.1119C19.8004 11 21.1446 11 21.7422 11.8787C22.3397 12.7575 21.8405 14.0002 20.842 16.4856L20.5436 17.2283C19.8097 19.0551 19.4428 19.9684 18.6776 20.4842C17.9124 21 16.9244 21 14.9484 21H6.88812C4.19961 21 2.85535 21 2.25782 20.1213C1.66029 19.2425 2.15953 17.9998 3.15802 15.5144Z" /> </svg> ${formatSize(pdf.file_size_mb)}</span>
          <button class="btn btn-sm view-btn" style="background:var(--green-dim);color:var(--green);border:1px solid var(--green-border);">View</button>
          <button class="btn btn-sm dl-btn" style="${dlBtnStyle}padding:7px 14px;"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" /> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" /> </svg> </button>
        </div>
      `
    }

    // â”€â”€ View PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleView(pdf) {
      if (!session) {
        toast('Please log in to view PDFs', 'warning')
        setTimeout(() => window.location.href = 'login.html?next=index.html', 1000)
        return
      }

      // Log the view
      await supabase.from('download_logs').insert({
        user_id: session.user.id,
        pdf_id:  pdf.id,
        action:  'view'
      })

      // Update profile viewed count
      await supabase.rpc('increment_views', { uid: session.user.id })

      // Navigate to view page
      window.location.href = `view.html?id=${pdf.id}`
    }

    // â”€â”€ Download PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleDownload(pdf) {
      if (!session) {
        toast('Please log in to download PDFs', 'warning')
        setTimeout(() => window.location.href = 'login.html?next=index.html', 1000)
        return
      }

      if (!canDownload) {
        const { count } = await supabase
          .from('download_logs')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', session.user.id)
          .eq('action', 'view')

        const remaining = 5 - (count || 0)
        toast(`View ${remaining} more PDF${remaining !== 1 ? 's' : ''} to unlock ğŸ‘€`, 'warning')
        return
      }

      // Log download
      await supabase.from('download_logs').insert({
        user_id: session.user.id,
        pdf_id:  pdf.id,
        action:  'download'
      })

      // Increment download counter
      await supabase
        .from('pdfs')
        .update({ download_count: (pdf.download_count || 0) + 1 })
        .eq('id', pdf.id)

      // Trigger download
      const { data } = supabase.storage.from('pdfs').getPublicUrl(pdf.file_url)
      const a = document.createElement('a')
      a.href = data.publicUrl
      a.download = pdf.title + '.pdf'
      a.click()

      toast(`Downloading "${pdf.title}" ğŸ“¥`)

      // Update local count
      pdf.download_count = (pdf.download_count || 0) + 1
    }

    // â”€â”€ View Hint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateViewHint() {
      const hint = document.getElementById('view-hint')
      if (!hint) return
      if (canDownload) {
        hint.innerHTML = `Downloads unlocked!`
        hint.className = 'view-hint unlocked'
      } else {
        hint.innerHTML = ` <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="currentColor" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round">
    <path d="M2 8C2 8 6.47715 3 12 3C17.5228 3 22 8 22 8" />
    <path d="M21.544 13.045C21.848 13.4713 22 13.6845 22 14C22 14.3155 21.848 14.5287 21.544 14.955C20.1779 16.8706 16.6892 21 12 21C7.31078 21 3.8221 16.8706 2.45604 14.955C2.15201 14.5287 2 14.3155 2 14C2 13.6845 2.15201 13.4713 2.45604 13.045C3.8221 11.1294 7.31078 7 12 7C16.6892 7 20.1779 11.1294 21.544 13.045Z" />
    <path d="M15 14C15 12.3431 13.6569 11 12 11C10.3431 11 9 12.3431 9 14C9 15.6569 10.3431 17 12 17C13.6569 17 15 15.6569 15 14Z" />
</svg> View 10 PDFs to unlock downloads`
        hint.className = 'view-hint locked'
      }
    }

    // â”€â”€ Results Meta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateResultsMeta() {
      const el = document.getElementById('results-count')
      if (el) el.innerHTML = `<span style="color:var(--green);font-weight:700;">${filtered.length}</span> PDFs found`
    }

    // â”€â”€ Category Chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildCategoryChips() {
      const row = document.getElementById('category-row')
      CATEGORIES.forEach(cat => {
        const btn = document.createElement('button')
        btn.className = `chip ${cat === 'All' ? 'active' : ''}`
        btn.textContent = cat
        btn.dataset.cat = cat
        btn.addEventListener('click', () => {
          document.querySelectorAll('#category-row .chip').forEach(c => c.classList.remove('active'))
          btn.classList.add('active')
          activeCategory = cat
          loadPdfs()
        })
        row.appendChild(btn)
      })
    }

    // â”€â”€ Bind Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindFilters() {
      // Type filter
      document.querySelectorAll('#type-filters .chip').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#type-filters .chip').forEach(b => b.classList.remove('active'))
          btn.classList.add('active')
          activeType = btn.dataset.type
          loadPdfs()
        })
      })

      // Uni type filter
      document.querySelectorAll('#uni-filters .chip').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#uni-filters .chip').forEach(b => b.classList.remove('active'))
          btn.classList.add('active')
          activeUni = btn.dataset.uni
          loadPdfs()
        })
      })

      // Sort
      document.getElementById('sort-recent').addEventListener('click', () => {
        document.querySelectorAll('.sort-wrap .chip').forEach(b => b.classList.remove('active'))
        document.getElementById('sort-recent').classList.add('active')
        activeSort = 'recent'
        loadPdfs()
      })
      document.getElementById('sort-popular').addEventListener('click', () => {
        document.querySelectorAll('.sort-wrap .chip').forEach(b => b.classList.remove('active'))
        document.getElementById('sort-popular').classList.add('active')
        activeSort = 'popular'
        loadPdfs()
      })

      // Load more
      document.getElementById('load-more-btn').addEventListener('click', () => {
        page++
        loadPdfs(true)
      })
    }

    // â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindSearch() {
      const input = document.getElementById('search-input')
      const btn   = document.getElementById('search-btn')
      let debounceTimer

      input.addEventListener('input', () => {
        clearTimeout(debounceTimer)
        debounceTimer = setTimeout(() => {
          searchQuery = input.value.trim()
          loadPdfs()
        }, 400)
      })

      btn.addEventListener('click', () => {
        searchQuery = input.value.trim()
        loadPdfs()
      })

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          searchQuery = input.value.trim()
          loadPdfs()
        }
      })
    }

    // â”€â”€ Skeletons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showSkeletons() {
      const grid = document.getElementById('pdf-grid')
      grid.innerHTML = Array(6).fill('<div class="skeleton-card"></div>').join('')
    }

    function clearSkeletons() {
      const grid = document.getElementById('pdf-grid')
      grid.innerHTML = ''
    }

    init()
  </script>

</body>
</html>
